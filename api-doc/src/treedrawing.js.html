<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Source for: treedrawing/data/scripts/treedrawing.js</title>
    
    <script src="../scripts/sh_main.js"> </script>
    <script src="../scripts/sh_javascript.js"> </script>
    <link type="text/css" rel="stylesheet" href="../styles/github.css">
</head>

<body>

  <pre>
<code>
<a name='L1'></a><span class="comment">// Copyright (c) 2011, 2012 Anton Karl Ingason, Aaron Ecay, Jana Beck</span>
<a name='L2'></a>
<a name='L3'></a><span class="comment">// This file is part of the Annotald program for annotating</span>
<a name='L4'></a><span class="comment">// phrase-structure treebanks in the Penn Treebank style.</span>
<a name='L5'></a>
<a name='L6'></a><span class="comment">// This file is distributed under the terms of the GNU General</span>
<a name='L7'></a><span class="comment">// Public License as published by the Free Software Foundation, either</span>
<a name='L8'></a><span class="comment">// version 3 of the License, or (at your option) any later version.</span>
<a name='L9'></a>
<a name='L10'></a><span class="comment">// This program is distributed in the hope that it will be useful, but</span>
<a name='L11'></a><span class="comment">// WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name='L12'></a><span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU Lesser</span>
<a name='L13'></a><span class="comment">// General Public License for more details.</span>
<a name='L14'></a>
<a name='L15'></a><span class="comment">// You should have received a copy of the GNU Lesser General Public</span>
<a name='L16'></a><span class="comment">// License along with this program.  If not, see</span>
<a name='L17'></a><span class="comment">// &lt;http://www.gnu.org/licenses/>.</span>
<a name='L18'></a>
<a name='L19'></a><span class="comment">// Global TODOs:</span>
<a name='L20'></a><span class="comment">// - (AWE) make the dash-tags modular, so that ctrl x -> set XXX, w -></span>
<a name='L21'></a><span class="comment">//   set NP-SBJ doesn't blow away the XXX</span>
<a name='L22'></a><span class="comment">// - (AWE) what happens when you delete e.g. an NP node w metadata?</span>
<a name='L23'></a><span class="comment">//   Does the metadata get blown away? pro/demoted? Does deletion fail, or</span>
<a name='L24'></a><span class="comment">//   raise a prompt?</span>
<a name='L25'></a><span class="comment">// - strict mode</span>
<a name='L26'></a><span class="comment">// - modularize doc -- namespaces?</span>
<a name='L27'></a>
<a name='L28'></a><span class="comment">// Notes for undo system:</span>
<a name='L29'></a><span class="comment">// - globally unique monotonic counter for root-level trees</span>
<a name='L30'></a><span class="comment">// - handle storing undo info in the key handler(/click hdlr)</span>
<a name='L31'></a><span class="comment">// - individual fns call touchtree(node) when they make a change</span>
<a name='L32'></a><span class="comment">// - touchtree stores the orig version of a tree, if in this transaction one</span>
<a name='L33'></a><span class="comment">//   hasn't been stored</span>
<a name='L34'></a><span class="comment">// - at end of oper, push an undo info onto the stack, consisting of:</span>
<a name='L35'></a><span class="comment">//   - replace tree #N with this data: X</span>
<a name='L36'></a><span class="comment">//   - put tree: X onto the global list, after tree #N</span>
<a name='L37'></a><span class="comment">//   - delete tree #N from global list</span>
<a name='L38'></a>
<a name='L39'></a><span class="comment">// Table of contents:</span>
<a name='L40'></a><span class="comment">// * Initialization</span>
<a name='L41'></a><span class="comment">// * User configuration</span>
<a name='L42'></a><span class="comment">// ** CSS styles</span>
<a name='L43'></a><span class="comment">// ** Key bindings</span>
<a name='L44'></a><span class="comment">// * UI functions</span>
<a name='L45'></a><span class="comment">// ** Event handlers</span>
<a name='L46'></a><span class="comment">// ** Context Menu</span>
<a name='L47'></a><span class="comment">// ** Messages</span>
<a name='L48'></a><span class="comment">// ** Dialog boxes</span>
<a name='L49'></a><span class="comment">// ** Selection</span>
<a name='L50'></a><span class="comment">// ** Metadata editor</span>
<a name='L51'></a><span class="comment">// ** Splitting words</span>
<a name='L52'></a><span class="comment">// ** Editing parts of the tree</span>
<a name='L53'></a><span class="comment">// ** Search</span>
<a name='L54'></a><span class="comment">// *** HTML strings and other globals</span>
<a name='L55'></a><span class="comment">// *** Event handlers</span>
<a name='L56'></a><span class="comment">// *** Helper functions</span>
<a name='L57'></a><span class="comment">// *** Search interpretation function</span>
<a name='L58'></a><span class="comment">// *** The core search function</span>
<a name='L59'></a><span class="comment">// * Tree manipulations</span>
<a name='L60'></a><span class="comment">// ** Movement</span>
<a name='L61'></a><span class="comment">// ** Creation</span>
<a name='L62'></a><span class="comment">// ** Deletion</span>
<a name='L63'></a><span class="comment">// ** Label manipulation</span>
<a name='L64'></a><span class="comment">// ** Coindexation</span>
<a name='L65'></a><span class="comment">// * Server-side operations</span>
<a name='L66'></a><span class="comment">// ** Saving</span>
<a name='L67'></a><span class="comment">// *** Save helper function</span>
<a name='L68'></a><span class="comment">// ** Validating</span>
<a name='L69'></a><span class="comment">// ** Advancing through the file</span>
<a name='L70'></a><span class="comment">// ** Idle/resume</span>
<a name='L71'></a><span class="comment">// ** Quitting</span>
<a name='L72'></a><span class="comment">// * Undo/redo</span>
<a name='L73'></a><span class="comment">// * Misc</span>
<a name='L74'></a><span class="comment">// * Misc (candidates to move to utils)</span>
<a name='L75'></a><span class="comment">// End TOC</span>
<a name='L76'></a>
<a name='L77'></a><span class="comment">// ===== Initialization</span>
<a name='L78'></a>
<a name='L79'></a><span class="keyword">var</span> startnode = <span class="keyword">null</span>;
<a name='L80'></a><span class="keyword">var</span> endnode = <span class="keyword">null</span>;
<a name='L81'></a><span class="keyword">var</span> ctrlKeyMap = <span class="keyword">new</span> Object();
<a name='L82'></a><span class="keyword">var</span> shiftKeyMap = <span class="keyword">new</span> Object();
<a name='L83'></a><span class="keyword">var</span> regularKeyMap = <span class="keyword">new</span> Object();
<a name='L84'></a>
<a name='L85'></a><span class="keyword">var</span> startuphooks = [];
<a name='L86'></a>
<a name='L87'></a><span class="keyword">var</span> last_event_was_mouse = <span class="keyword">false</span>;
<a name='L88'></a><span class="keyword">var</span> lastsavedstate = <span class="string">""</span>;
<a name='L89'></a>
<a name='L90'></a><span class="keyword">var</span> globalStyle = $(<span class="string">'&lt;style type="text/css">&lt;/style>'</span>);
<a name='L91'></a>
<a name='L92'></a><span class="keyword">var</span> lemmataStyleNode, lemmataHidden = <span class="keyword">false</span>;
<a name='L93'></a>(<span class="keyword">function</span> () {
<a name='L94'></a>    lemmataStyleNode = document.createElement(<span class="string">"style"</span>);
<a name='L95'></a>    lemmataStyleNode.setAttribute(<span class="string">"type"</span>, <span class="string">"text/css"</span>);
<a name='L96'></a>    document.getElementsByTagName(<span class="string">"head"</span>)[<span class="number">0</span>].appendChild(lemmataStyleNode);
<a name='L97'></a>    lemmataStyleNode.innerHTML = <span class="string">".lemma { display: none; }"</span>;
<a name='L98'></a>})();
<a name='L99'></a>
<a name='L100'></a>String.prototype.startsWith = <span class="keyword">function</span>(str) {
<a name='L101'></a>    <span class="keyword">return</span> (<span class="keyword">this</span>.substr(<span class="number">0</span>,str.length) === str);
<a name='L102'></a>};
<a name='L103'></a>
<a name='L104'></a>String.prototype.endsWith = <span class="keyword">function</span>(str) {
<a name='L105'></a>    <span class="keyword">return</span> (<span class="keyword">this</span>.substr(<span class="keyword">this</span>.length-str.length) === str);
<a name='L106'></a>};
<a name='L107'></a>
<a name='L108'></a><span class="comment">/*
<a name='L109'></a> * unique function by: Shamasis Bhattacharya
<a name='L110'></a> * http://www.shamasis.net/2009/09/fast-algorithm-to-find-unique-items-in-javascript-array/
<a name='L111'></a> */</span>
<a name='L112'></a><span class="keyword">Array</span>.prototype.unique = <span class="keyword">function</span>() {
<a name='L113'></a>    <span class="keyword">var</span> o = {}, i, l = <span class="keyword">this</span>.length, r = [];
<a name='L114'></a>    <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;l;i+=<span class="number">1</span>) o[<span class="keyword">this</span>[i]] = <span class="keyword">this</span>[i];
<a name='L115'></a>    <span class="keyword">for</span>(i in o) r.push(o[i]);
<a name='L116'></a>    <span class="keyword">return</span> r;
<a name='L117'></a>};
<a name='L118'></a>
<a name='L119'></a><span class="keyword">function</span> navigationWarning() {
<a name='L120'></a>    <span class="keyword">if</span> ($(<span class="string">"#editpane"</span>).html() != lastsavedstate) {
<a name='L121'></a>        <span class="keyword">return</span> <span class="string">"Unsaved changes exist, are you sure you want to leave the page?"</span>;
<a name='L122'></a>    }
<a name='L123'></a>    <span class="keyword">return</span> undefined;
<a name='L124'></a>}
<a name='L125'></a>
<a name='L126'></a><span class="keyword">function</span> assignEvents() {
<a name='L127'></a>    <span class="comment">// load custom commands from user settings file</span>
<a name='L128'></a>    customCommands();
<a name='L129'></a>    document.body.onkeydown = handleKeyDown;
<a name='L130'></a>    $(<span class="string">"#sn0"</span>).mousedown(handleNodeClick);
<a name='L131'></a>    $(<span class="string">"#butsave"</span>).mousedown(save);
<a name='L132'></a>    $(<span class="string">"#butundo"</span>).mousedown(undo);
<a name='L133'></a>    $(<span class="string">"#butredo"</span>).mousedown(redo);
<a name='L134'></a>    $(<span class="string">"#butidle"</span>).mousedown(idle);
<a name='L135'></a>    $(<span class="string">"#butexit"</span>).unbind(<span class="string">"click"</span>).click(quitServer);
<a name='L136'></a>    $(<span class="string">"#butvalidate"</span>).unbind(<span class="string">"click"</span>).click(validateTrees);
<a name='L137'></a>    $(<span class="string">"#butnexterr"</span>).unbind(<span class="string">"click"</span>).click(nextValidationError);
<a name='L138'></a>    $(<span class="string">"#butnexttree"</span>).unbind(<span class="string">"click"</span>).click(nextTree);
<a name='L139'></a>    $(<span class="string">"#butprevtree"</span>).unbind(<span class="string">"click"</span>).click(prevTree);
<a name='L140'></a>    $(<span class="string">"#editpane"</span>).mousedown(clearSelection);
<a name='L141'></a>    $(<span class="string">"#conMenu"</span>).mousedown(hideContextMenu);
<a name='L142'></a>    $(document).mousewheel(handleMouseWheel);
<a name='L143'></a>    window.onbeforeunload = navigationWarning;
<a name='L144'></a>}
<a name='L145'></a>
<a name='L146'></a><span class="comment">// TODO: is this still current?</span>
<a name='L147'></a><span class="keyword">function</span> hideCategories() {
<a name='L148'></a>    <span class="keyword">var</span> i;
<a name='L149'></a>    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; invisibleRootCategories.length; i++) {
<a name='L150'></a>        addStyle(<span class="string">"#sn0>."</span> + invisibleRootCategories[i] + <span class="string">"{display:none;}"</span>);
<a name='L151'></a>    }
<a name='L152'></a>    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; invisibleCategories.length; i++) {
<a name='L153'></a>        addStyle(<span class="string">"."</span> + invisibleCategories[i] + <span class="string">"{display:none;}"</span>);
<a name='L154'></a>    }
<a name='L155'></a>}
<a name='L156'></a>
<a name='L157'></a><span class="keyword">function</span> styleIpNodes() {
<a name='L158'></a>    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; ipnodes.length; i++) {
<a name='L159'></a>        styleTag(ipnodes[i], <span class="string">"border-top: 1px solid black;"</span> +
<a name='L160'></a>                 <span class="string">"border-bottom: 1px solid black;"</span> +
<a name='L161'></a>                 <span class="string">"background-color: #C5908E;"</span>);
<a name='L162'></a>    }
<a name='L163'></a>}
<a name='L164'></a>
<a name='L165'></a><span class="keyword">function</span> addStartupHook(fn) {
<a name='L166'></a>    startuphooks.push(fn);
<a name='L167'></a>}
<a name='L168'></a>
<a name='L169'></a><span class="keyword">function</span> documentReadyHandler() {
<a name='L170'></a>    <span class="comment">// TODO: something is very slow here; profile</span>
<a name='L171'></a>    $(<span class="string">"#editpane>.snode"</span>).attr(<span class="string">"id"</span>, <span class="string">"sn0"</span>);
<a name='L172'></a>    <span class="comment">// TODO: move some of this into hooks</span>
<a name='L173'></a>    assignEvents();
<a name='L174'></a>    styleIpNodes();
<a name='L175'></a>    hideCategories();
<a name='L176'></a>    setupCommentTypes();
<a name='L177'></a>    globalStyle.appendTo(<span class="string">"head"</span>);
<a name='L178'></a>
<a name='L179'></a>    _.each(startuphooks, <span class="keyword">function</span> (hook) {
<a name='L180'></a>        hook();
<a name='L181'></a>    });
<a name='L182'></a>
<a name='L183'></a>    lastsavedstate = $(<span class="string">"#editpane"</span>).html();
<a name='L184'></a>}
<a name='L185'></a>
<a name='L186'></a>$(document).ready(<span class="keyword">function</span> () {
<a name='L187'></a>    documentReadyHandler();
<a name='L188'></a>});
<a name='L189'></a>
<a name='L190'></a><span class="comment">// ===== User configuration</span>
<a name='L191'></a>
<a name='L192'></a><span class="comment">// ========== CSS styles</span>
<a name='L193'></a>
<a name='L194'></a><span class="keyword">function</span> addStyle(string) {
<a name='L195'></a>    <span class="keyword">var</span> style = globalStyle.text() + <span class="string">"\n"</span> + string;
<a name='L196'></a>    globalStyle.text(style);
<a name='L197'></a>}
<a name='L198'></a>
<a name='L199'></a><span class="comment">/**
<a name='L200'></a> * Add a css style for a certain tag.
<a name='L201'></a> *
<a name='L202'></a> *<span class="phpdoc"> @param</span> {String} tagName The tag which to style.  Will match instances of
<a name='L203'></a> * the given tag with additional trailing dash tags.
<a name='L204'></a> *<span class="phpdoc"> @param</span> {String} css The css style declarations to associate with the tag.
<a name='L205'></a> */</span>
<a name='L206'></a><span class="keyword">function</span> styleTag(tagName, css) {
<a name='L207'></a>    addStyle(<span class="string">'*[class*=" '</span> + tagName + <span class="string">'-"],*[class*=" '</span> + tagName +
<a name='L208'></a>             <span class="string">' "],*[class$=" '</span> + tagName + <span class="string">'"],[class*=" '</span> + tagName +
<a name='L209'></a>             <span class="string">'="] { '</span> + css + <span class="string">' }'</span>);
<a name='L210'></a>}
<a name='L211'></a>
<a name='L212'></a><span class="comment">/**
<a name='L213'></a> * Add a css style for a certain dash tag.
<a name='L214'></a> *
<a name='L215'></a> *<span class="phpdoc"> @param</span> {String} tagName The tag which to style.  Will match any node with
<a name='L216'></a> * this dash tag.  Should not itself have leading or trailing dashes.
<a name='L217'></a> *<span class="phpdoc"> @param</span> {String} css The css style declarations to associate with the tag.
<a name='L218'></a> */</span>
<a name='L219'></a><span class="keyword">function</span> styleDashTag(tagName, css) {
<a name='L220'></a>    addStyle(<span class="string">'*[class*="-'</span> + tagName + <span class="string">'-"],*[class*="-'</span> + tagName +
<a name='L221'></a>             <span class="string">' "],*[class$="-'</span> + tagName + <span class="string">'"],[class*="-'</span> + tagName +
<a name='L222'></a>             <span class="string">'="] { '</span> + css + <span class="string">' }'</span>);
<a name='L223'></a>}
<a name='L224'></a>
<a name='L225'></a><span class="comment">/**
<a name='L226'></a> * A convenience function to wrap {@link styleTag}.
<a name='L227'></a> *
<a name='L228'></a> *<span class="phpdoc"> @param</span> {Array} tagNames Tags to style.
<a name='L229'></a> *<span class="phpdoc"> @param</span> {String} css The css style declarations to associate with the tags.
<a name='L230'></a> */</span>
<a name='L231'></a><span class="keyword">function</span> styleTags(tagNames, css) {
<a name='L232'></a>    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; tagNames.length; i++) {
<a name='L233'></a>        styleTag(tagNames[i], css);
<a name='L234'></a>    }
<a name='L235'></a>}
<a name='L236'></a>
<a name='L237'></a><span class="comment">// ========== Key bindings</span>
<a name='L238'></a>
<a name='L239'></a><span class="comment">/**
<a name='L240'></a> * Add a keybinding command.
<a name='L241'></a> *
<a name='L242'></a> * Calls to this function should be in the `settings.js` file, grouped in a
<a name='L243'></a> * function called `customCommands`
<a name='L244'></a> *
<a name='L245'></a> *<span class="phpdoc"> @param</span> {Object} dict a mapping of properties of the keybinding.  Can
<a name='L246'></a> * contain:
<a name='L247'></a> *
<a name='L248'></a> * - `keycode`: the numeric keycode for the binding (mandatory)
<a name='L249'></a> * - `shift`: true if this is a binding with shift pressed (optional)
<a name='L250'></a> * - `ctrl`: true if this is a binding with control pressed (optional)
<a name='L251'></a> *
<a name='L252'></a> *<span class="phpdoc"> @param</span> {Function} fn the function to associate with the keybinding.  Any
<a name='L253'></a> * further arguments to the `addCommand` function are passed to `fn` on each
<a name='L254'></a> * invocation.
<a name='L255'></a> */</span>
<a name='L256'></a><span class="keyword">function</span> addCommand(dict, fn) {
<a name='L257'></a>    <span class="keyword">var</span> commandMap;
<a name='L258'></a>    <span class="keyword">if</span> (dict.ctrl) {
<a name='L259'></a>        commandMap = ctrlKeyMap;
<a name='L260'></a>    } <span class="keyword">else</span> <span class="keyword">if</span> (dict.shift) {
<a name='L261'></a>        commandMap = shiftKeyMap;
<a name='L262'></a>    } <span class="keyword">else</span> {
<a name='L263'></a>        commandMap = regularKeyMap;
<a name='L264'></a>    }
<a name='L265'></a>    commandMap[dict.keycode] = {
<a name='L266'></a>        func: fn,
<a name='L267'></a>        args: <span class="keyword">Array</span>.prototype.slice.call(arguments, <span class="number">2</span>)
<a name='L268'></a>    };
<a name='L269'></a>}
<a name='L270'></a>
<a name='L271'></a><span class="comment">// ===== UI functions</span>
<a name='L272'></a>
<a name='L273'></a><span class="comment">// ========== Event handlers</span>
<a name='L274'></a>
<a name='L275'></a><span class="keyword">function</span> handleMouseWheel(e, delta) {
<a name='L276'></a>    <span class="keyword">if</span> (e.shiftKey &amp;&amp; startnode) {
<a name='L277'></a>        <span class="keyword">var</span> nextNode;
<a name='L278'></a>        <span class="keyword">if</span> (delta &lt; <span class="number">0</span>) { <span class="comment">// negative means scroll down, counterintuitively</span>
<a name='L279'></a>             nextNode = $(startnode).next().get(<span class="number">0</span>);
<a name='L280'></a>        } <span class="keyword">else</span> {
<a name='L281'></a>            nextNode = $(startnode).prev().get(<span class="number">0</span>);
<a name='L282'></a>        }
<a name='L283'></a>        <span class="keyword">if</span> (nextNode) {
<a name='L284'></a>            selectNode(nextNode);
<a name='L285'></a>            scrollToShowSel();
<a name='L286'></a>        }
<a name='L287'></a>    }
<a name='L288'></a>}
<a name='L289'></a>
<a name='L290'></a><span class="keyword">function</span> handleKeyDown(e) {
<a name='L291'></a>    <span class="keyword">if</span> ((e.ctrlKey &amp;&amp; e.shiftKey) || e.metaKey || e.altKey) {
<a name='L292'></a>        <span class="comment">// unsupported modifier combinations</span>
<a name='L293'></a>        <span class="keyword">return</span> <span class="keyword">true</span>;
<a name='L294'></a>    }
<a name='L295'></a>    <span class="keyword">var</span> commandMap;
<a name='L296'></a>    <span class="keyword">if</span> (e.ctrlKey) {
<a name='L297'></a>        commandMap = ctrlKeyMap;
<a name='L298'></a>    } <span class="keyword">else</span> <span class="keyword">if</span> (e.shiftKey) {
<a name='L299'></a>        commandMap = shiftKeyMap;
<a name='L300'></a>    } <span class="keyword">else</span> {
<a name='L301'></a>        commandMap = regularKeyMap;
<a name='L302'></a>    }
<a name='L303'></a>    last_event_was_mouse = <span class="keyword">false</span>;
<a name='L304'></a>    <span class="keyword">if</span> (!commandMap[e.keyCode]) {
<a name='L305'></a>        <span class="keyword">return</span> <span class="keyword">true</span>;
<a name='L306'></a>    }
<a name='L307'></a>    e.preventDefault();
<a name='L308'></a>    <span class="keyword">var</span> theFn = commandMap[e.keyCode].func;
<a name='L309'></a>    <span class="keyword">var</span> theArgs = commandMap[e.keyCode].args;
<a name='L310'></a>    theFn.apply(undefined, theArgs);
<a name='L311'></a>    <span class="keyword">if</span> (!theFn.async) {
<a name='L312'></a>        undoBarrier();
<a name='L313'></a>    }
<a name='L314'></a>    <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L315'></a>}
<a name='L316'></a>
<a name='L317'></a><span class="keyword">function</span> handleNodeClick(e) {
<a name='L318'></a>    e = e || window.event;
<a name='L319'></a>    <span class="keyword">var</span> element = (e.target || e.srcElement);
<a name='L320'></a>    saveMetadata();
<a name='L321'></a>    <span class="keyword">if</span> (e.button == <span class="number">2</span>) {
<a name='L322'></a>        <span class="comment">// rightclick</span>
<a name='L323'></a>        <span class="keyword">if</span> (startnode &amp;&amp; !endnode) {
<a name='L324'></a>            <span class="keyword">if</span> (startnode != element) {
<a name='L325'></a>                e.stopPropagation();
<a name='L326'></a>                moveNode(element);
<a name='L327'></a>            } <span class="keyword">else</span> {
<a name='L328'></a>                showContextMenu(e);
<a name='L329'></a>            }
<a name='L330'></a>        } <span class="keyword">else</span> <span class="keyword">if</span> (startnode &amp;&amp; endnode) {
<a name='L331'></a>            e.stopPropagation();
<a name='L332'></a>            moveNodes(element);
<a name='L333'></a>        } <span class="keyword">else</span> {
<a name='L334'></a>            showContextMenu(e);
<a name='L335'></a>        }
<a name='L336'></a>    } <span class="keyword">else</span> {
<a name='L337'></a>        <span class="comment">// leftclick</span>
<a name='L338'></a>        hideContextMenu();
<a name='L339'></a>        <span class="keyword">if</span> (e.shiftKey &amp;&amp; startnode) {
<a name='L340'></a>            endnode = element;
<a name='L341'></a>            updateSelection();
<a name='L342'></a>            e.preventDefault(); <span class="comment">// Otherwise, this sets the text</span>
<a name='L343'></a>                                <span class="comment">// selection in the browser...</span>
<a name='L344'></a>        } <span class="keyword">else</span> {
<a name='L345'></a>            selectNode(element);
<a name='L346'></a>            <span class="keyword">if</span> (e.ctrlKey) {
<a name='L347'></a>                makeNode(<span class="string">"XP"</span>);
<a name='L348'></a>            }
<a name='L349'></a>        }
<a name='L350'></a>    }
<a name='L351'></a>    e.stopPropagation();
<a name='L352'></a>    last_event_was_mouse = <span class="keyword">true</span>;
<a name='L353'></a>    undoBarrier();
<a name='L354'></a>}
<a name='L355'></a>
<a name='L356'></a><span class="comment">// ========== Context Menu</span>
<a name='L357'></a>
<a name='L358'></a><span class="keyword">function</span> showContextMenu(e) {
<a name='L359'></a>    <span class="keyword">var</span> element = e.target || e.srcElement;
<a name='L360'></a>    <span class="keyword">if</span> (element == document.getElementById(<span class="string">"sn0"</span>)) {
<a name='L361'></a>        clearSelection();
<a name='L362'></a>        <span class="keyword">return</span>;
<a name='L363'></a>    }
<a name='L364'></a>
<a name='L365'></a>    <span class="keyword">var</span> left = e.pageX;
<a name='L366'></a>    <span class="keyword">var</span> top = e.pageY;
<a name='L367'></a>    left = left + <span class="string">"px"</span>;
<a name='L368'></a>    top = top + <span class="string">"px"</span>;
<a name='L369'></a>
<a name='L370'></a>    <span class="keyword">var</span> conl = $(<span class="string">"#conLeft"</span>),
<a name='L371'></a>        conr = $(<span class="string">"#conRight"</span>),
<a name='L372'></a>        conm = $(<span class="string">"#conMenu"</span>);
<a name='L373'></a>
<a name='L374'></a>    conl.<span class="keyword">empty</span>();
<a name='L375'></a>    loadContextMenu(element);
<a name='L376'></a>
<a name='L377'></a>    <span class="comment">// Make the columns equally high</span>
<a name='L378'></a>    conl.height(<span class="string">"auto"</span>);
<a name='L379'></a>    conr.height(<span class="string">"auto"</span>);
<a name='L380'></a>    <span class="keyword">if</span> (conl.height() &lt; conr.height()) {
<a name='L381'></a>        conl.height(conr.height());
<a name='L382'></a>    } <span class="keyword">else</span> {
<a name='L383'></a>        conr.height(conl.height());
<a name='L384'></a>    }
<a name='L385'></a>
<a name='L386'></a>    conm.css(<span class="string">"left"</span>,left);
<a name='L387'></a>    conm.css(<span class="string">"top"</span>,top);
<a name='L388'></a>    conm.css(<span class="string">"visibility"</span>,<span class="string">"visible"</span>);
<a name='L389'></a>}
<a name='L390'></a>
<a name='L391'></a><span class="keyword">function</span> hideContextMenu() {
<a name='L392'></a>    $(<span class="string">"#conMenu"</span>).css(<span class="string">"visibility"</span>,<span class="string">"hidden"</span>);
<a name='L393'></a>}
<a name='L394'></a>
<a name='L395'></a><span class="comment">// ========== Messages</span>
<a name='L396'></a>
<a name='L397'></a><span class="comment">/**
<a name='L398'></a> * Show the message history.
<a name='L399'></a> */</span>
<a name='L400'></a><span class="keyword">function</span> showMessageHistory() {
<a name='L401'></a>    showDialogBox(<span class="string">"Messages"</span>, <span class="string">"&lt;textarea style='width:100%;height:100%;'>"</span> +
<a name='L402'></a>                  messageHistory + <span class="string">"&lt;/textarea>"</span>);
<a name='L403'></a>}
<a name='L404'></a>addStartupHook(<span class="keyword">function</span> () {
<a name='L405'></a>    $(<span class="string">"#messagesTitle"</span>).click(showMessageHistory);
<a name='L406'></a>});
<a name='L407'></a>
<a name='L408'></a><span class="comment">// ========== Dialog boxes</span>
<a name='L409'></a>
<a name='L410'></a><span class="comment">/**
<a name='L411'></a> * Show a dialog box.
<a name='L412'></a> *
<a name='L413'></a> * This function creates keybindings for the escape (to close dialog box) and
<a name='L414'></a> * return (caller-specified behavior) keys.
<a name='L415'></a> *
<a name='L416'></a> *<span class="phpdoc"> @param</span> {String} title the title of the dialog box
<a name='L417'></a> *<span class="phpdoc"> @param</span> {String} html the html to display in the dialog box
<a name='L418'></a> *<span class="phpdoc"> @param</span> {Function} returnFn a function to call when return is pressed
<a name='L419'></a> *<span class="phpdoc"> @param</span> {Function} hideHook a function to run when hiding the dialog box
<a name='L420'></a> */</span>
<a name='L421'></a><span class="keyword">function</span> showDialogBox(title, html, returnFn, hideHook) {
<a name='L422'></a>    document.body.onkeydown = <span class="keyword">function</span> (e) {
<a name='L423'></a>        <span class="keyword">if</span> (e.keyCode == <span class="number">27</span>) { <span class="comment">// escape</span>
<a name='L424'></a>            <span class="keyword">if</span> (hideHook) {
<a name='L425'></a>                hideHook();
<a name='L426'></a>            }
<a name='L427'></a>            hideDialogBox();
<a name='L428'></a>        } <span class="keyword">else</span> <span class="keyword">if</span> (e.keyCode == <span class="number">13</span> &amp;&amp; returnFn) {
<a name='L429'></a>            returnFn();
<a name='L430'></a>        }
<a name='L431'></a>    };
<a name='L432'></a>    html = <span class="string">'&lt;div class="menuTitle">'</span> + title + <span class="string">'&lt;/div>'</span> +
<a name='L433'></a>        <span class="string">'&lt;div id="dialogContent">'</span> + html + <span class="string">'&lt;/div>'</span>;
<a name='L434'></a>    $(<span class="string">"#dialogBox"</span>).html(html).get(<span class="number">0</span>).style.visibility = <span class="string">"visible"</span>;
<a name='L435'></a>    $(<span class="string">"#dialogBackground"</span>).get(<span class="number">0</span>).style.visibility = <span class="string">"visible"</span>;
<a name='L436'></a>}
<a name='L437'></a>
<a name='L438'></a><span class="comment">/**
<a name='L439'></a> * Hide the displayed dialog box.
<a name='L440'></a> */</span>
<a name='L441'></a><span class="keyword">function</span> hideDialogBox() {
<a name='L442'></a>    $(<span class="string">"#dialogBox"</span>).get(<span class="number">0</span>).style.visibility = <span class="string">"hidden"</span>;
<a name='L443'></a>    $(<span class="string">"#dialogBackground"</span>).get(<span class="number">0</span>).style.visibility = <span class="string">"hidden"</span>;
<a name='L444'></a>    document.body.onkeydown = handleKeyDown;
<a name='L445'></a>}
<a name='L446'></a>
<a name='L447'></a><span class="comment">/**
<a name='L448'></a> * Set a handler for the enter key in a text box.
<a name='L449'></a> *<span class="phpdoc"> @private</span>
<a name='L450'></a> */</span>
<a name='L451'></a><span class="keyword">function</span> setInputFieldEnter(field, fn) {
<a name='L452'></a>    field.keydown(<span class="keyword">function</span> (e) {
<a name='L453'></a>        <span class="keyword">if</span> (e.keyCode == <span class="number">13</span>) {
<a name='L454'></a>            fn();
<a name='L455'></a>            <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L456'></a>        } <span class="keyword">else</span> {
<a name='L457'></a>            <span class="keyword">return</span> <span class="keyword">true</span>;
<a name='L458'></a>        }
<a name='L459'></a>    });
<a name='L460'></a>}
<a name='L461'></a>
<a name='L462'></a><span class="comment">// ========== Selection</span>
<a name='L463'></a>
<a name='L464'></a><span class="comment">/**
<a name='L465'></a> * Select a node, and update the GUI to reflect that.
<a name='L466'></a> *
<a name='L467'></a> *<span class="phpdoc"> @param</span> {DOM Node} node the node to be selected
<a name='L468'></a> */</span>
<a name='L469'></a><span class="keyword">function</span> selectNode(node) {
<a name='L470'></a>    <span class="keyword">if</span> (node) {
<a name='L471'></a>        <span class="keyword">if</span> (!(node instanceof Node)) {
<a name='L472'></a>            <span class="keyword">try</span> {
<a name='L473'></a>                <span class="keyword">throw</span> Error(<span class="string">"foo"</span>);
<a name='L474'></a>            } <span class="keyword">catch</span> (e) {
<a name='L475'></a>                console.log(<span class="string">"selecting a non-node: "</span> + e.stack);
<a name='L476'></a>            }
<a name='L477'></a>        }
<a name='L478'></a>        <span class="keyword">if</span> (node == document.getElementById(<span class="string">"sn0"</span>)) {
<a name='L479'></a>            clearSelection();
<a name='L480'></a>            <span class="keyword">return</span>;
<a name='L481'></a>        }
<a name='L482'></a>
<a name='L483'></a>        <span class="keyword">if</span> (node.className == <span class="string">"wnode"</span>) {
<a name='L484'></a>            node = node.parentNode;
<a name='L485'></a>        }
<a name='L486'></a>
<a name='L487'></a>        <span class="keyword">if</span> (node == startnode) {
<a name='L488'></a>            startnode = <span class="keyword">null</span>;
<a name='L489'></a>            <span class="keyword">if</span> (endnode) {
<a name='L490'></a>                startnode = endnode;
<a name='L491'></a>                endnode = <span class="keyword">null</span>;
<a name='L492'></a>            }
<a name='L493'></a>        } <span class="keyword">else</span> <span class="keyword">if</span> (startnode == <span class="keyword">null</span>) {
<a name='L494'></a>            startnode = node;
<a name='L495'></a>        } <span class="keyword">else</span> {
<a name='L496'></a>            <span class="keyword">if</span> (last_event_was_mouse) {
<a name='L497'></a>                <span class="keyword">if</span> (node == endnode) {
<a name='L498'></a>                    endnode = <span class="keyword">null</span>;
<a name='L499'></a>                } <span class="keyword">else</span> {
<a name='L500'></a>                    endnode = node;
<a name='L501'></a>                }
<a name='L502'></a>            } <span class="keyword">else</span> {
<a name='L503'></a>                endnode = <span class="keyword">null</span>;
<a name='L504'></a>                startnode = node;
<a name='L505'></a>            }
<a name='L506'></a>        }
<a name='L507'></a>        updateSelection();
<a name='L508'></a>    } <span class="keyword">else</span> {
<a name='L509'></a>        <span class="keyword">try</span> {
<a name='L510'></a>            <span class="keyword">throw</span> Error(<span class="string">"foo"</span>);
<a name='L511'></a>        } <span class="keyword">catch</span> (e) {
<a name='L512'></a>            console.log(<span class="string">"tried to select something falsey: "</span> + e.stack);
<a name='L513'></a>        }
<a name='L514'></a>    }
<a name='L515'></a>}
<a name='L516'></a>
<a name='L517'></a><span class="comment">/**
<a name='L518'></a> * Remove any selection of nodes.
<a name='L519'></a> */</span>
<a name='L520'></a><span class="keyword">function</span> clearSelection() {
<a name='L521'></a>    saveMetadata();
<a name='L522'></a>    window.event.preventDefault();
<a name='L523'></a>    startnode = endnode = <span class="keyword">null</span>;
<a name='L524'></a>    updateSelection();
<a name='L525'></a>    hideContextMenu();
<a name='L526'></a>}
<a name='L527'></a>
<a name='L528'></a><span class="keyword">function</span> updateSelection() {
<a name='L529'></a>    <span class="comment">// update selection display</span>
<a name='L530'></a>    $(<span class="string">'.snodesel'</span>).removeClass(<span class="string">'snodesel'</span>);
<a name='L531'></a>
<a name='L532'></a>    <span class="keyword">if</span> (startnode) {
<a name='L533'></a>        $(startnode).addClass(<span class="string">'snodesel'</span>);
<a name='L534'></a>    }
<a name='L535'></a>
<a name='L536'></a>    <span class="keyword">if</span> (endnode) {
<a name='L537'></a>        $(endnode).addClass(<span class="string">'snodesel'</span>);
<a name='L538'></a>    }
<a name='L539'></a>
<a name='L540'></a>    updateMetadataEditor();
<a name='L541'></a>}
<a name='L542'></a>
<a name='L543'></a><span class="comment">/**
<a name='L544'></a> * Scroll the page so that the first selected node is visible.
<a name='L545'></a> */</span>
<a name='L546'></a><span class="keyword">function</span> scrollToShowSel() {
<a name='L547'></a>    <span class="keyword">function</span> isTopVisible(elem) {
<a name='L548'></a>        <span class="keyword">var</span> docViewTop = $(window).scrollTop();
<a name='L549'></a>        <span class="keyword">var</span> docViewBottom = docViewTop + $(window).height();
<a name='L550'></a>        <span class="keyword">var</span> elemTop = $(elem).offset().top;
<a name='L551'></a>
<a name='L552'></a>        <span class="keyword">return</span> ((elemTop &lt;= docViewBottom) &amp;&amp; (elemTop >= docViewTop));
<a name='L553'></a>    }
<a name='L554'></a>    <span class="keyword">if</span> (!isTopVisible(startnode)) {
<a name='L555'></a>        window.scroll(<span class="number">0</span>, $(startnode).offset().top - $(window).height() * <span class="number">0.25</span>);
<a name='L556'></a>    }
<a name='L557'></a>}
<a name='L558'></a>
<a name='L559'></a><span class="comment">// ========== Metadata editor</span>
<a name='L560'></a>
<a name='L561'></a><span class="keyword">function</span> saveMetadata() {
<a name='L562'></a>    <span class="keyword">if</span> ($(<span class="string">"#metadata"</span>).html() != <span class="string">""</span>) {
<a name='L563'></a>        $(startnode).attr(<span class="string">"data-metadata"</span>,
<a name='L564'></a>                          JSON.stringify(formToDictionary($(<span class="string">"#metadata"</span>))));
<a name='L565'></a>    }
<a name='L566'></a>}
<a name='L567'></a>
<a name='L568'></a><span class="keyword">function</span> updateMetadataEditor() {
<a name='L569'></a>    <span class="keyword">if</span> (!startnode || endnode) {
<a name='L570'></a>        $(<span class="string">"#metadata"</span>).html(<span class="string">""</span>);
<a name='L571'></a>        <span class="keyword">return</span>;
<a name='L572'></a>    }
<a name='L573'></a>    <span class="keyword">var</span> addButtonHtml = <span class="string">'&lt;input type="button" id="addMetadataButton" '</span> +
<a name='L574'></a>            <span class="string">'value="Add" />'</span>;
<a name='L575'></a>    $(<span class="string">"#metadata"</span>).html(dictionaryToForm(getMetadata($(startnode))) +
<a name='L576'></a>                        addButtonHtml);
<a name='L577'></a>    $(<span class="string">"#metadata"</span>).find(<span class="string">".metadataField"</span>).change(saveMetadata).
<a name='L578'></a>        focusout(saveMetadata).keydown(<span class="keyword">function</span> (e) {
<a name='L579'></a>            <span class="keyword">if</span> (e.keyCode == <span class="number">13</span>) {
<a name='L580'></a>                $(e.target).blur();
<a name='L581'></a>            }
<a name='L582'></a>            e.stopPropagation();
<a name='L583'></a>            <span class="keyword">return</span> <span class="keyword">true</span>;
<a name='L584'></a>        });
<a name='L585'></a>    $(<span class="string">"#metadata"</span>).find(<span class="string">".key"</span>).click(metadataKeyClick);
<a name='L586'></a>    $(<span class="string">"#addMetadataButton"</span>).click(addMetadataDialog);
<a name='L587'></a>}
<a name='L588'></a>
<a name='L589'></a>
<a name='L590'></a>
<a name='L591'></a><span class="keyword">function</span> metadataKeyClick(e) {
<a name='L592'></a>    <span class="keyword">var</span> keyNode = e.target;
<a name='L593'></a>    <span class="keyword">var</span> html = <span class="string">'Name: &lt;input type="text" '</span> +
<a name='L594'></a>            <span class="string">'id="metadataNewName" value="'</span> + $(keyNode).text() +
<a name='L595'></a>            <span class="string">'" />&lt;div id="dialogButtons">&lt;input type="button" value="Save" '</span> +
<a name='L596'></a>        <span class="string">'id="metadataKeySave" />&lt;input type="button" value="Delete" '</span> +
<a name='L597'></a>        <span class="string">'id="metadataKeyDelete" />&lt;/div>'</span>;
<a name='L598'></a>    showDialogBox(<span class="string">"Edit Metadata"</span>, html);
<a name='L599'></a>    <span class="comment">// TODO: make focus go to end, or select whole thing?</span>
<a name='L600'></a>    $(<span class="string">"#metadataNewName"</span>).focus();
<a name='L601'></a>    <span class="keyword">function</span> saveMetadataInner() {
<a name='L602'></a>        $(keyNode).text($(<span class="string">"#metadataNewName"</span>).val());
<a name='L603'></a>        hideDialogBox();
<a name='L604'></a>        saveMetadata();
<a name='L605'></a>    }
<a name='L606'></a>    <span class="keyword">function</span> deleteMetadata() {
<a name='L607'></a>        $(keyNode).<span class="keyword">parent</span>().remove();
<a name='L608'></a>        hideDialogBox();
<a name='L609'></a>        saveMetadata();
<a name='L610'></a>    }
<a name='L611'></a>    $(<span class="string">"#metadataKeySave"</span>).click(saveMetadataInner);
<a name='L612'></a>    setInputFieldEnter($(<span class="string">"#metadataNewName"</span>), saveMetadataInner);
<a name='L613'></a>    $(<span class="string">"#metadataKeyDelete"</span>).click(deleteMetadata);
<a name='L614'></a>}
<a name='L615'></a>
<a name='L616'></a><span class="keyword">function</span> addMetadataDialog() {
<a name='L617'></a>    <span class="comment">// TODO: allow specifying value too in initial dialog?</span>
<a name='L618'></a>    <span class="keyword">var</span> html = <span class="string">'New Name: &lt;input type="text" id="metadataNewName" value="NEW" />'</span> +
<a name='L619'></a>            <span class="string">'&lt;div id="dialogButtons">&lt;input type="button" id="addMetadata" '</span> +
<a name='L620'></a>            <span class="string">'value="Add" />&lt;/div>'</span>;
<a name='L621'></a>    showDialogBox(<span class="string">"Add Metatata"</span>, html);
<a name='L622'></a>    <span class="keyword">function</span> addMetadata() {
<a name='L623'></a>        <span class="keyword">var</span> oldMetadata = formToDictionary($(<span class="string">"#metadata"</span>));
<a name='L624'></a>        oldMetadata[$(<span class="string">"#metadataNewName"</span>).val()] = <span class="string">"NEW"</span>;
<a name='L625'></a>        $(startnode).attr(<span class="string">"data-metadata"</span>, JSON.stringify(oldMetadata));
<a name='L626'></a>        updateMetadataEditor();
<a name='L627'></a>        hideDialogBox();
<a name='L628'></a>    }
<a name='L629'></a>    $(<span class="string">"#addMetadata"</span>).click(addMetadata);
<a name='L630'></a>    setInputFieldEnter($(<span class="string">"#metadataNewName"</span>), addMetadata);
<a name='L631'></a>}
<a name='L632'></a>
<a name='L633'></a><span class="comment">// ========== Splitting words</span>
<a name='L634'></a>
<a name='L635'></a><span class="keyword">function</span> splitWord() {
<a name='L636'></a>    <span class="keyword">if</span> (!startnode || endnode) <span class="keyword">return</span>;
<a name='L637'></a>    <span class="keyword">if</span> (!isLeafNode($(startnode)) || isEmpty(startnode)) <span class="keyword">return</span>;
<a name='L638'></a>    touchTree($(startnode));
<a name='L639'></a>    <span class="keyword">var</span> wordSplit = wnodeString($(startnode)).split(<span class="string">"-"</span>);
<a name='L640'></a>    <span class="keyword">var</span> origWord = wordSplit[<span class="number">0</span>];
<a name='L641'></a>    <span class="keyword">var</span> origLemma = <span class="string">"XXX"</span>;
<a name='L642'></a>    <span class="keyword">if</span> (wordSplit.length == <span class="number">2</span>) {
<a name='L643'></a>        origLemma = <span class="string">"@"</span> + wordSplit[<span class="number">1</span>] + <span class="string">"@"</span>;
<a name='L644'></a>    }
<a name='L645'></a>    <span class="keyword">var</span> origLabel = getLabel($(startnode));
<a name='L646'></a>    <span class="keyword">function</span> doSplit() {
<a name='L647'></a>        <span class="keyword">var</span> words = $(<span class="string">"#splitWordInput"</span>).val().split(<span class="string">"@"</span>);
<a name='L648'></a>        <span class="keyword">if</span> (words.join(<span class="string">""</span>) != origWord) {
<a name='L649'></a>            displayWarning(<span class="string">"The two new words don't match the original.  Aborting"</span>);
<a name='L650'></a>            <span class="keyword">return</span>;
<a name='L651'></a>        }
<a name='L652'></a>        <span class="keyword">if</span> (words.length != <span class="number">2</span>) {
<a name='L653'></a>            displayWarning(<span class="string">"You can only split in one place at a time."</span>);
<a name='L654'></a>            <span class="keyword">return</span>;
<a name='L655'></a>        }
<a name='L656'></a>        <span class="keyword">var</span> labelSplit = origLabel.split(<span class="string">"+"</span>);
<a name='L657'></a>        <span class="keyword">var</span> secondLabel = <span class="string">"X"</span>;
<a name='L658'></a>        <span class="keyword">if</span> (labelSplit.length == <span class="number">2</span>) {
<a name='L659'></a>            setLeafLabel($(startnode), labelSplit[<span class="number">0</span>]);
<a name='L660'></a>            secondLabel = labelSplit[<span class="number">1</span>];
<a name='L661'></a>        }
<a name='L662'></a>        setLeafLabel($(startnode), words[<span class="number">0</span>] + <span class="string">"@"</span>);
<a name='L663'></a>        <span class="keyword">var</span> hasLemma = $(startnode).find(<span class="string">".lemma"</span>).size() > <span class="number">0</span>;
<a name='L664'></a>        makeLeaf(<span class="keyword">false</span>, secondLabel, <span class="string">"@"</span> + words[<span class="number">1</span>]);
<a name='L665'></a>        <span class="keyword">if</span> (hasLemma) {
<a name='L666'></a>            <span class="comment">// TODO: move to something like foo@1 and foo@2 for the two pieces</span>
<a name='L667'></a>            <span class="comment">// of the lemmata</span>
<a name='L668'></a>            addLemma(origLemma);
<a name='L669'></a>        }
<a name='L670'></a>        hideDialogBox();
<a name='L671'></a>    }
<a name='L672'></a>    <span class="keyword">var</span> html = <span class="string">"Enter an at-sign at the place to split the word: \
<a name='L673'></a>&lt;input type='text' id='splitWordInput' value='"</span> + origWord +
<a name='L674'></a><span class="string">"' />&lt;div id='dialogButtons'>&lt;input type='button' id='splitWordButton'\
<a name='L675'></a> value='Split' />&lt;/div>"</span>;
<a name='L676'></a>    showDialogBox(<span class="string">"Split word"</span>, html, doSplit);
<a name='L677'></a>    $(<span class="string">"#splitWordButton"</span>).click(doSplit);
<a name='L678'></a>    $(<span class="string">"#splitWordInput"</span>).focus();
<a name='L679'></a>}
<a name='L680'></a>
<a name='L681'></a><span class="comment">// ========== Editing parts of the tree</span>
<a name='L682'></a>
<a name='L683'></a><span class="comment">// TODO: document entry points better</span>
<a name='L684'></a><span class="comment">// DONE(?): split these fns up...they are monsters.  (or split to sep. file?)</span>
<a name='L685'></a>
<a name='L686'></a><span class="comment">/**
<a name='L687'></a> * Edit the lemma, if a leaf node is selected, or the label, if a phrasal node is.
<a name='L688'></a> */</span>
<a name='L689'></a><span class="keyword">function</span> editLemmaOrLabel() {
<a name='L690'></a>    <span class="keyword">if</span> (getLabel($(startnode)) == <span class="string">"CODE"</span> &amp;&amp;
<a name='L691'></a>        (wnodeString($(startnode)).substring(<span class="number">0</span>,<span class="number">4</span>) == <span class="string">"{COM"</span> ||
<a name='L692'></a>         wnodeString($(startnode)).substring(<span class="number">0</span>,<span class="number">5</span>) == <span class="string">"{TODO"</span> ||
<a name='L693'></a>         wnodeString($(startnode)).substring(<span class="number">0</span>,<span class="number">4</span>) == <span class="string">"{MAN"</span>)) {
<a name='L694'></a>        editComment();
<a name='L695'></a>    } <span class="keyword">else</span> <span class="keyword">if</span> (isLeafNode(startnode)) {
<a name='L696'></a>        editLemma();
<a name='L697'></a>    } <span class="keyword">else</span> {
<a name='L698'></a>        displayRename();
<a name='L699'></a>    }
<a name='L700'></a>}
<a name='L701'></a>
<a name='L702'></a><span class="keyword">var</span> commentTypeCheckboxes = <span class="string">""</span>;
<a name='L703'></a>
<a name='L704'></a><span class="keyword">function</span> setupCommentTypes() {
<a name='L705'></a>    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; commentTypes.length; i++) {
<a name='L706'></a>        commentTypeCheckboxes +=
<a name='L707'></a>            <span class="string">'&lt;input type="radio" name="commentType" value="'</span> +
<a name='L708'></a>            commentTypes[i] + <span class="string">'" id="commentType'</span> + commentTypes[i] +
<a name='L709'></a>            <span class="string">'" /> '</span> + commentTypes[i];
<a name='L710'></a>    }
<a name='L711'></a>}
<a name='L712'></a>
<a name='L713'></a><span class="keyword">function</span> editComment() {
<a name='L714'></a>    <span class="keyword">if</span> (!startnode || endnode) <span class="keyword">return</span>;
<a name='L715'></a>    touchTree($(startnode));
<a name='L716'></a>    <span class="keyword">var</span> commentRaw = $.trim(wnodeString($(startnode)));
<a name='L717'></a>    <span class="keyword">var</span> commentType = commentRaw.split(<span class="string">":"</span>)[<span class="number">0</span>];
<a name='L718'></a>    <span class="comment">// remove the {</span>
<a name='L719'></a>    commentType = commentType.substring(<span class="number">1</span>);
<a name='L720'></a>    <span class="keyword">var</span> commentText = commentRaw.split(<span class="string">":"</span>)[<span class="number">1</span>];
<a name='L721'></a>    commentText = commentText.substring(<span class="number">0</span>, commentText.length - <span class="number">1</span>);
<a name='L722'></a>    <span class="comment">// regex because string does not give global search.</span>
<a name='L723'></a>    commentText = commentText.replace(/_/g, <span class="string">" "</span>);
<a name='L724'></a>    showDialogBox(<span class="string">"Edit Comment"</span>,
<a name='L725'></a>                  <span class="string">'&lt;textarea id="commentEditBox">'</span> +
<a name='L726'></a>                  commentText + <span class="string">'&lt;/textarea>&lt;div id="commentTypes">'</span> +
<a name='L727'></a>                  commentTypeCheckboxes + <span class="string">'&lt;/div>&lt;div id="dialogButtons">'</span> +
<a name='L728'></a>                  <span class="string">'&lt;input type="button"'</span> +
<a name='L729'></a>                  <span class="string">'id="commentEditButton" value="Save" />&lt;/div>'</span>);
<a name='L730'></a>    $(<span class="string">"input:radio[name=commentType]"</span>).val([commentType]);
<a name='L731'></a>    $(<span class="string">"#commentEditBox"</span>).focus().get(<span class="number">0</span>).setSelectionRange(commentText.length,
<a name='L732'></a>                                                          commentText.length);
<a name='L733'></a>    <span class="keyword">function</span> editCommentDone (change) {
<a name='L734'></a>        <span class="keyword">if</span> (change) {
<a name='L735'></a>            <span class="keyword">var</span> newText = $.trim($(<span class="string">"#commentEditBox"</span>).val());
<a name='L736'></a>            <span class="keyword">if</span> (/_|\n|:|\}|\{|\(|\)/.test(newText)) {
<a name='L737'></a>                <span class="comment">// TODO(AWE): slicker way of indicating errors...</span>
<a name='L738'></a>                alert(<span class="string">"illegal characters in comment: illegal characters are"</span> +
<a name='L739'></a>                      <span class="string">" _, :, {}, (), and newline"</span>);
<a name='L740'></a>                <span class="comment">// hideDialogBox();</span>
<a name='L741'></a>                $(<span class="string">"#commentEditBox"</span>).val(newText);
<a name='L742'></a>                <span class="keyword">return</span>;
<a name='L743'></a>            }
<a name='L744'></a>            newText = newText.replace(/ /g, <span class="string">"_"</span>);
<a name='L745'></a>            commentType = $(<span class="string">"input:radio[name=commentType]:checked"</span>).val();
<a name='L746'></a>            setLabelLL($(startnode).children(<span class="string">".wnode"</span>),
<a name='L747'></a>                       <span class="string">"{"</span> + commentType + <span class="string">":"</span> + newText + <span class="string">"}"</span>);
<a name='L748'></a>        }
<a name='L749'></a>        hideDialogBox();
<a name='L750'></a>    }
<a name='L751'></a>    $(<span class="string">"#commentEditButton"</span>).click(editCommentDone);
<a name='L752'></a>    $(<span class="string">"#commentEditBox"</span>).keydown(<span class="keyword">function</span> (e) {
<a name='L753'></a>        <span class="keyword">if</span> (e.keyCode == <span class="number">13</span>) {
<a name='L754'></a>            <span class="comment">// return</span>
<a name='L755'></a>            editCommentDone(<span class="keyword">true</span>);
<a name='L756'></a>            <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L757'></a>        } <span class="keyword">else</span> <span class="keyword">if</span> (e.keyCode == <span class="number">27</span>) {
<a name='L758'></a>            editCommentDone(<span class="keyword">false</span>);
<a name='L759'></a>            <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L760'></a>        } <span class="keyword">else</span> {
<a name='L761'></a>            <span class="keyword">return</span> <span class="keyword">true</span>;
<a name='L762'></a>        }
<a name='L763'></a>    });
<a name='L764'></a>}
<a name='L765'></a>
<a name='L766'></a><span class="comment">/**
<a name='L767'></a> * Return the JQuery object with the editor for a leaf node.
<a name='L768'></a> *<span class="phpdoc"> @private</span>
<a name='L769'></a> */</span>
<a name='L770'></a><span class="keyword">function</span> leafEditorHtml(label, word, lemma) {
<a name='L771'></a>    <span class="comment">// Single quotes mess up the HTML code.</span>
<a name='L772'></a>    <span class="keyword">if</span> (lemma) lemma = lemma.replace(/<span class="string">'/g, "&amp;#39;");
<a name='L773'></a>    word = word.replace(/'</span>/g, <span class="string">"&amp;#39;"</span>);
<a name='L774'></a>    label = label.replace(/<span class="string">'/g, "&amp;#39;");
<a name='L775'></a>
<a name='L776'></a>    var editorHtml = "&lt;div id='</span>leafeditor<span class="string">' class='</span>snode<span class="string">'>" +
<a name='L777'></a>            "&lt;input id='</span>leafphrasebox<span class="string">' class='</span>labeledit<span class="string">' type='</span>text<span class="string">' value='</span><span class="string">" +
<a name='L778'></a>            label +
<a name='L779'></a>            "</span><span class="string">' />&lt;input id='</span>leaftextbox<span class="string">' class='</span>labeledit<span class="string">' type='</span>text<span class="string">' value='</span><span class="string">" +
<a name='L780'></a>            word +
<a name='L781'></a>            "</span><span class="string">' " + (!isEmpty(word) ? "disabled='</span>disabled<span class="string">'" : "") + " />";
<a name='L782'></a>    if (lemma) {
<a name='L783'></a>        editorHtml += "&lt;input id='</span>leaflemmabox<span class="string">' class='</span>labeledit<span class="string">' " +
<a name='L784'></a>            "type='</span>text<span class="string">' value='</span><span class="string">" + lemma + "</span><span class="string">' />";
<a name='L785'></a>    }
<a name='L786'></a>    editorHtml += "&lt;/div>";
<a name='L787'></a>
<a name='L788'></a>    return $(editorHtml);
<a name='L789'></a>}
<a name='L790'></a>
<a name='L791'></a>/**
<a name='L792'></a> * Return the JQuery object with the replacement after editing a leaf node.
<a name='L793'></a> * @private
<a name='L794'></a> */
<a name='L795'></a>function leafEditorReplacement(label, word, lemma) {
<a name='L796'></a>    if (lemma) {
<a name='L797'></a>        lemma = lemma.replace(/&lt;/g,"&amp;lt;");
<a name='L798'></a>        lemma = lemma.replace(/>/g,"&amp;gt;");
<a name='L799'></a>        lemma = lemma.replace(/'</span>/g,<span class="string">"&amp;#39;"</span>);
<a name='L800'></a>    }
<a name='L801'></a>
<a name='L802'></a>    word = word.replace(/&lt;/g,<span class="string">"&amp;lt;"</span>);
<a name='L803'></a>    word = word.replace(/>/g,<span class="string">"&amp;gt;"</span>);
<a name='L804'></a>    word = word.replace(/<span class="string">'/g,"&amp;#39;");
<a name='L805'></a>
<a name='L806'></a>    // TODO: test for illegal chars in label
<a name='L807'></a>    label = label.toUpperCase();
<a name='L808'></a>
<a name='L809'></a>    var replText = "&lt;div class='</span>snode<span class="string">'>" + label +
<a name='L810'></a>            " &lt;span class='</span>wnode<span class="string">'>" + word;
<a name='L811'></a>    if (lemma) {
<a name='L812'></a>        replText += "&lt;span class='</span>lemma<span class="string">'>-" +
<a name='L813'></a>            lemma + "&lt;/span>";
<a name='L814'></a>    }
<a name='L815'></a>    replText += "&lt;/span>&lt;/div>";
<a name='L816'></a>    return $(replText);
<a name='L817'></a>}
<a name='L818'></a>
<a name='L819'></a>/**
<a name='L820'></a> * Edit the selected node
<a name='L821'></a> *
<a name='L822'></a> * If the selected node is a terminal, edit its label, and lemma.  The text is
<a name='L823'></a> * available for editing if it is an empty node (trace, comment, etc.).  If a
<a name='L824'></a> * non-terminal, edit the node label.
<a name='L825'></a> */
<a name='L826'></a>function displayRename() {
<a name='L827'></a>    // Inner functions
<a name='L828'></a>    function space(event) {
<a name='L829'></a>        var element = (event.target || event.srcElement);
<a name='L830'></a>        $(element).val($(element).val());
<a name='L831'></a>        event.preventDefault();
<a name='L832'></a>    }
<a name='L833'></a>    function postChange(newNode) {
<a name='L834'></a>        if (newNode) {
<a name='L835'></a>            updateCssClass(newNode, oldClass);
<a name='L836'></a>            startnode = endnode = null;
<a name='L837'></a>            updateSelection();
<a name='L838'></a>            document.body.onkeydown = handleKeyDown;
<a name='L839'></a>            $("#sn0").mousedown(handleNodeClick);
<a name='L840'></a>            $("#editpane").mousedown(clearSelection);
<a name='L841'></a>            $("#undo").attr("disabled", false);
<a name='L842'></a>            $("#redo").attr("disabled", false);
<a name='L843'></a>            $("#save").attr("disabled", false);
<a name='L844'></a>        }
<a name='L845'></a>    }
<a name='L846'></a>
<a name='L847'></a>    // Begin code
<a name='L848'></a>    if (!startnode || endnode) {
<a name='L849'></a>        return;
<a name='L850'></a>    }
<a name='L851'></a>    undoBeginTransaction();
<a name='L852'></a>    touchTree($(startnode));
<a name='L853'></a>    document.body.onkeydown = null;
<a name='L854'></a>    $("#sn0").unbind('</span>mousedown<span class="string">');
<a name='L855'></a>    $("#editpane").unbind('</span>mousedown<span class="string">');
<a name='L856'></a>    $("#undo").attr("disabled", true);
<a name='L857'></a>    $("#redo").attr("disabled", true);
<a name='L858'></a>    $("#save").attr("disabled", true);
<a name='L859'></a>    var label = getLabel($(startnode));
<a name='L860'></a>    var oldClass = parseLabel(label);
<a name='L861'></a>
<a name='L862'></a>    if ($(startnode).children(".wnode").size() > 0) {
<a name='L863'></a>        // this is a terminal
<a name='L864'></a>        var word, lemma;
<a name='L865'></a>        // is this right? we still want to allow editing of index, maybe?
<a name='L866'></a>        var isLeafNode = guessLeafNode($(startnode));
<a name='L867'></a>        if ($(startnode).children(".wnode").children(".lemma").size() > 0) {
<a name='L868'></a>            var preword = $.trim($(startnode).children().first().text());
<a name='L869'></a>            preword = preword.split("-");
<a name='L870'></a>            lemma = preword.pop();
<a name='L871'></a>            word = preword.join("-");
<a name='L872'></a>        } else {
<a name='L873'></a>            word = $.trim($(startnode).children().first().text());
<a name='L874'></a>        }
<a name='L875'></a>
<a name='L876'></a>        $(startnode).replaceWith(leafEditorHtml(label, word, lemma));
<a name='L877'></a>
<a name='L878'></a>        $("#leafphrasebox,#leaftextbox,#leaflemmabox").keydown(
<a name='L879'></a>            function(event) {
<a name='L880'></a>                var replText, replNode;
<a name='L881'></a>                if (event.keyCode == 32) {
<a name='L882'></a>                    space(event);
<a name='L883'></a>                }
<a name='L884'></a>                if (event.keyCode == 27) {
<a name='L885'></a>                    replNode = leafEditorReplacement(label, word, lemma);
<a name='L886'></a>                    $("#leafeditor").replaceWith(replNode);
<a name='L887'></a>                    postChange(replNode);
<a name='L888'></a>                    undoAbortTransaction();
<a name='L889'></a>                }
<a name='L890'></a>                if (event.keyCode == 13) {
<a name='L891'></a>                    var newlabel = $("#leafphrasebox").val();
<a name='L892'></a>                    var newword = $("#leaftextbox").val();
<a name='L893'></a>                    var newlemma;
<a name='L894'></a>                    if (lemma) {
<a name='L895'></a>                        newlemma = $('</span><span class="comment">#leaflemmabox').val();</span>
<a name='L896'></a>                    }
<a name='L897'></a>
<a name='L898'></a>                    <span class="keyword">if</span> (isLeafNode) {
<a name='L899'></a>                        <span class="keyword">if</span> (typeof testValidLeafLabel !== <span class="string">"undefined"</span>) {
<a name='L900'></a>                            <span class="keyword">if</span> (!testValidLeafLabel(newlabel)) {
<a name='L901'></a>                                displayWarning(<span class="string">"Not a valid leaf label: '"</span> +
<a name='L902'></a>                                               newlabel + <span class="string">"'."</span>);
<a name='L903'></a>                                <span class="keyword">return</span>;
<a name='L904'></a>                            }
<a name='L905'></a>                        }
<a name='L906'></a>                    } <span class="keyword">else</span> {
<a name='L907'></a>                        <span class="keyword">if</span> (typeof testValidPhraseLabel !== <span class="string">"undefined"</span>) {
<a name='L908'></a>                            <span class="keyword">if</span> (!testValidPhraseLabel(newlabel)) {
<a name='L909'></a>                                displayWarning(<span class="string">"Not a valid phrase label: '"</span> +
<a name='L910'></a>                                               newlabel + <span class="string">"'."</span>);
<a name='L911'></a>                                <span class="keyword">return</span>;
<a name='L912'></a>                            }
<a name='L913'></a>                        }
<a name='L914'></a>                    }
<a name='L915'></a>                    <span class="keyword">if</span> (newword + newlemma == <span class="string">""</span>) {
<a name='L916'></a>                        displayWarning(<span class="string">"Cannot create an empty leaf."</span>);
<a name='L917'></a>                        <span class="keyword">return</span>;
<a name='L918'></a>                    }
<a name='L919'></a>                    replNode = leafEditorReplacement(newlabel, newword,
<a name='L920'></a>                                                     newlemma);
<a name='L921'></a>                    $(<span class="string">"#leafeditor"</span>).replaceWith(replNode);
<a name='L922'></a>                    postChange(replNode);
<a name='L923'></a>                    undoEndTransaction();
<a name='L924'></a>                    undoBarrier();
<a name='L925'></a>                }
<a name='L926'></a>                <span class="keyword">if</span> (event.keyCode == <span class="number">9</span>) {
<a name='L927'></a>                    <span class="keyword">var</span> element = (event.target || event.srcElement);
<a name='L928'></a>                    <span class="keyword">if</span> ($(<span class="string">"#leafphrasebox"</span>).is(element)) {
<a name='L929'></a>                        <span class="keyword">if</span> (!$(<span class="string">"#leaftextbox"</span>).attr(<span class="string">"disabled"</span>)) {
<a name='L930'></a>                            $(<span class="string">"#leaftextbox"</span>).focus();
<a name='L931'></a>                        } <span class="keyword">else</span> <span class="keyword">if</span> ($(<span class="string">"#leaflemmabox"</span>).length == <span class="number">1</span>) {
<a name='L932'></a>                            $(<span class="string">"#leaflemmabox"</span>).focus();
<a name='L933'></a>                        }
<a name='L934'></a>                    } <span class="keyword">else</span> <span class="keyword">if</span> ($(<span class="string">"#leaftextbox"</span>).is(element)) {
<a name='L935'></a>                        <span class="keyword">if</span> ($(<span class="string">"#leaflemmabox"</span>).length == <span class="number">1</span>) {
<a name='L936'></a>                            $(<span class="string">"#leaflemmabox"</span>).focus();
<a name='L937'></a>                        } <span class="keyword">else</span> {
<a name='L938'></a>                            $(<span class="string">"#leafphrasebox"</span>).focus();
<a name='L939'></a>                        }
<a name='L940'></a>                    } <span class="keyword">else</span> <span class="keyword">if</span> ($(<span class="string">"#leaflemmabox"</span>).is(element)) {
<a name='L941'></a>                        $(<span class="string">"#leafphrasebox"</span>).focus();
<a name='L942'></a>                    }
<a name='L943'></a>                    event.preventDefault();
<a name='L944'></a>                }
<a name='L945'></a>            });
<a name='L946'></a>        setTimeout(<span class="keyword">function</span>(){ $(<span class="string">"#leafphrasebox"</span>).focus(); }, <span class="number">10</span>);
<a name='L947'></a>    } <span class="keyword">else</span> {
<a name='L948'></a>        <span class="comment">// this is not a terminal</span>
<a name='L949'></a>        <span class="keyword">var</span> editor = $(<span class="string">"&lt;input id='labelbox' class='labeledit' "</span> +
<a name='L950'></a>                       <span class="string">"type='text' value='"</span> + label + <span class="string">"' />"</span>);
<a name='L951'></a>        <span class="keyword">var</span> origNode = $(startnode);
<a name='L952'></a>        <span class="keyword">var</span> isWordLevelConj =
<a name='L953'></a>                origNode.children(<span class="string">".snode"</span>).children(<span class="string">".snode"</span>).size() == <span class="number">0</span> &amp;&amp;
<a name='L954'></a>                <span class="comment">// TODO: make configurable</span>
<a name='L955'></a>                origNode.children(<span class="string">".CONJ"</span>) .size() > <span class="number">0</span>;
<a name='L956'></a>        textNode(origNode).replaceWith(editor);
<a name='L957'></a>        $(<span class="string">"#labelbox"</span>).keydown(
<a name='L958'></a>            <span class="keyword">function</span>(event) {
<a name='L959'></a>                <span class="keyword">if</span> (event.keyCode == <span class="number">9</span>) {
<a name='L960'></a>                    event.preventDefault();
<a name='L961'></a>                }
<a name='L962'></a>                <span class="keyword">if</span> (event.keyCode == <span class="number">32</span>) {
<a name='L963'></a>                    space(event);
<a name='L964'></a>                }
<a name='L965'></a>                <span class="keyword">if</span> (event.keyCode == <span class="number">27</span>) {
<a name='L966'></a>                    $(<span class="string">"#labelbox"</span>).replaceWith(label + <span class="string">" "</span>);
<a name='L967'></a>                    postChange(origNode);
<a name='L968'></a>                    undoAbortTransaction();
<a name='L969'></a>                }
<a name='L970'></a>                <span class="keyword">if</span> (event.keyCode == <span class="number">13</span>) {
<a name='L971'></a>                    <span class="keyword">var</span> newphrase = $(<span class="string">"#labelbox"</span>).val().toUpperCase();
<a name='L972'></a>                    <span class="keyword">if</span> (typeof testValidPhraseLabel !== <span class="string">"undefined"</span>) {
<a name='L973'></a>                        <span class="keyword">if</span> (!(testValidPhraseLabel(newphrase) ||
<a name='L974'></a>                              (typeof testValidLeafLabel !== <span class="string">"undefined"</span> &amp;&amp;
<a name='L975'></a>                               isWordLevelConj &amp;&amp;
<a name='L976'></a>                               testValidLeafLabel(newphrase)))) {
<a name='L977'></a>                            displayWarning(<span class="string">"Not a valid phrase label: '"</span> +
<a name='L978'></a>                                           newphrase + <span class="string">"'."</span>);
<a name='L979'></a>                            <span class="keyword">return</span>;
<a name='L980'></a>                        }
<a name='L981'></a>                    }
<a name='L982'></a>                    $(<span class="string">"#labelbox"</span>).replaceWith(newphrase + <span class="string">" "</span>);
<a name='L983'></a>                    postChange(origNode);
<a name='L984'></a>                    undoEndTransaction();
<a name='L985'></a>                    undoBarrier();
<a name='L986'></a>                }
<a name='L987'></a>            });
<a name='L988'></a>        setTimeout(<span class="keyword">function</span>(){ $(<span class="string">"#labelbox"</span>).focus(); }, <span class="number">10</span>);
<a name='L989'></a>    }
<a name='L990'></a>}
<a name='L991'></a>displayRename.async = <span class="keyword">true</span>;
<a name='L992'></a>
<a name='L993'></a><span class="comment">/**
<a name='L994'></a> * Edit the lemma of a terminal node.
<a name='L995'></a> */</span>
<a name='L996'></a><span class="keyword">function</span> editLemma() {
<a name='L997'></a>    <span class="comment">// Inner functions</span>
<a name='L998'></a>    <span class="keyword">function</span> space(event) {
<a name='L999'></a>        <span class="keyword">var</span> element = (event.target || event.srcElement);
<a name='L1000'></a>        $(element).val($(element).val());
<a name='L1001'></a>        event.preventDefault();
<a name='L1002'></a>    }
<a name='L1003'></a>    <span class="keyword">function</span> postChange() {
<a name='L1004'></a>        startnode = <span class="keyword">null</span>; endnode = <span class="keyword">null</span>;
<a name='L1005'></a>        updateSelection();
<a name='L1006'></a>        document.body.onkeydown = handleKeyDown;
<a name='L1007'></a>        $(<span class="string">"#sn0"</span>).mousedown(handleNodeClick);
<a name='L1008'></a>        $(<span class="string">"#undo"</span>).attr(<span class="string">"disabled"</span>, <span class="keyword">false</span>);
<a name='L1009'></a>        $(<span class="string">"#redo"</span>).attr(<span class="string">"disabled"</span>, <span class="keyword">false</span>);
<a name='L1010'></a>        $(<span class="string">"#save"</span>).attr(<span class="string">"disabled"</span>, <span class="keyword">false</span>);
<a name='L1011'></a>        undoBarrier();
<a name='L1012'></a>    }
<a name='L1013'></a>
<a name='L1014'></a>    <span class="comment">// Begin code</span>
<a name='L1015'></a>    <span class="keyword">var</span> childLemmata = $(startnode).children(<span class="string">".wnode"</span>).children(<span class="string">".lemma"</span>);
<a name='L1016'></a>    <span class="keyword">if</span> (!startnode || endnode || childLemmata.size() != <span class="number">1</span>) {
<a name='L1017'></a>        <span class="keyword">return</span>;
<a name='L1018'></a>    }
<a name='L1019'></a>    document.body.onkeydown = <span class="keyword">null</span>;
<a name='L1020'></a>    $(<span class="string">"#sn0"</span>).unbind(<span class="string">'mousedown'</span>);
<a name='L1021'></a>    undoBeginTransaction();
<a name='L1022'></a>    touchTree($(startnode));
<a name='L1023'></a>    $(<span class="string">"#undo"</span>).attr(<span class="string">"disabled"</span>, <span class="keyword">true</span>);
<a name='L1024'></a>    $(<span class="string">"#redo"</span>).attr(<span class="string">"disabled"</span>, <span class="keyword">true</span>);
<a name='L1025'></a>    $(<span class="string">"#save"</span>).attr(<span class="string">"disabled"</span>, <span class="keyword">true</span>);
<a name='L1026'></a>
<a name='L1027'></a>    <span class="keyword">var</span> lemma = $(startnode).children(<span class="string">".wnode"</span>).children(<span class="string">".lemma"</span>).text();
<a name='L1028'></a>    lemma = lemma.substring(<span class="number">1</span>);
<a name='L1029'></a>    <span class="keyword">var</span> editor=$(<span class="string">"&lt;span id='leafeditor' class='wnode'>&lt;input "</span> +
<a name='L1030'></a>                 <span class="string">"id='leaflemmabox' class='labeledit' type='text' value='"</span> +
<a name='L1031'></a>                 lemma + <span class="string">"' />&lt;/span>"</span>);
<a name='L1032'></a>    $(startnode).children(<span class="string">".wnode"</span>).children(<span class="string">".lemma"</span>).replaceWith(editor);
<a name='L1033'></a>    $(<span class="string">"#leaflemmabox"</span>).keydown(
<a name='L1034'></a>        <span class="keyword">function</span>(event) {
<a name='L1035'></a>            <span class="keyword">if</span> (event.keyCode == <span class="number">9</span>) {
<a name='L1036'></a>                event.preventDefault();
<a name='L1037'></a>            }
<a name='L1038'></a>            <span class="keyword">if</span> (event.keyCode == <span class="number">32</span>) {
<a name='L1039'></a>                space(event);
<a name='L1040'></a>            }
<a name='L1041'></a>            <span class="keyword">if</span> (event.keyCode == <span class="number">13</span>) {
<a name='L1042'></a>                <span class="keyword">var</span> newlemma = $(<span class="string">'#leaflemmabox'</span>).val();
<a name='L1043'></a>                newlemma = newlemma.replace(<span class="string">"&lt;"</span>,<span class="string">"&amp;lt;"</span>);
<a name='L1044'></a>                newlemma = newlemma.replace(<span class="string">">"</span>,<span class="string">"&amp;gt;"</span>);
<a name='L1045'></a>                newlemma = newlemma.replace(/<span class="string">'/g,"&amp;#39;");
<a name='L1046'></a>
<a name='L1047'></a>                $("#leafeditor").replaceWith("&lt;span class='</span>lemma<span class="string">'>-" +
<a name='L1048'></a>                                             newlemma + "&lt;/span>");
<a name='L1049'></a>                postChange();
<a name='L1050'></a>            }
<a name='L1051'></a>            // TODO: escape
<a name='L1052'></a>        });
<a name='L1053'></a>    setTimeout(function(){ $("#leaflemmabox").focus(); }, 10);
<a name='L1054'></a>}
<a name='L1055'></a>editLemma.async = true;
<a name='L1056'></a>
<a name='L1057'></a>// ========== Search
<a name='L1058'></a>
<a name='L1059'></a>// TODO: anchor right end of string, so that NP does not match NPR, only NP or NP-X (???)
<a name='L1060'></a>
<a name='L1061'></a>// TODO: profile this and optimize like crazy.
<a name='L1062'></a>
<a name='L1063'></a>// =============== HTML strings and other globals
<a name='L1064'></a>
<a name='L1065'></a>/**
<a name='L1066'></a> * The HTML code for a regular search node
<a name='L1067'></a> * @private
<a name='L1068'></a> * @constant
<a name='L1069'></a> */
<a name='L1070'></a>var searchnodehtml = "&lt;div class='</span>searchnode<span class="string">'>" +
<a name='L1071'></a>        "&lt;div class='</span>searchadddelbuttons<span class="string">'>" +
<a name='L1072'></a>        "&lt;input type='</span>button<span class="string">' class='</span>searchornodebut<span class="string">' " +
<a name='L1073'></a>        "value='</span>|<span class="string">' />" +
<a name='L1074'></a>        "&lt;input type='</span>button<span class="string">' class='</span>searchdeepnodebut<span class="string">' " +
<a name='L1075'></a>        "value='</span>D<span class="string">' />" +
<a name='L1076'></a>        "&lt;input type='</span>button<span class="string">' class='</span>searchprecnodebut<span class="string">' " +
<a name='L1077'></a>        "value='</span>><span class="string">' />" +
<a name='L1078'></a>        "&lt;input type='</span>button<span class="string">' class='</span>searchdelnodebut<span class="string">' " +
<a name='L1079'></a>        "value='</span>-<span class="string">' />" +
<a name='L1080'></a>        "&lt;input type='</span>button<span class="string">' class='</span>searchnewnodebut<span class="string">' " +
<a name='L1081'></a>        "value='</span>+<span class="string">' />" +
<a name='L1082'></a>        "&lt;/div>" +
<a name='L1083'></a>        "&lt;select class='</span>searchtype<span class="string">'>&lt;option>Label&lt;/option>" +
<a name='L1084'></a>        "&lt;option>Text&lt;/option>&lt;/select>: " +
<a name='L1085'></a>        "&lt;input type='</span>text<span class="string">' class='</span>searchtext<span class="string">' />" +
<a name='L1086'></a>        "&lt;/div>";
<a name='L1087'></a>
<a name='L1088'></a>/**
<a name='L1089'></a> * The HTML code for an "or" search node
<a name='L1090'></a> * @private
<a name='L1091'></a> * @constant
<a name='L1092'></a> */
<a name='L1093'></a>var searchornodehtml = "&lt;div class='</span>searchnode searchornode<span class="string">'>" +
<a name='L1094'></a>        "&lt;div class='</span>searchadddelbuttons<span class="string">'>" +
<a name='L1095'></a>        "&lt;input type='</span>button<span class="string">' class='</span>searchdelnodebut<span class="string">' value='</span>-<span class="string">' />" +
<a name='L1096'></a>        "&lt;/div>" +
<a name='L1097'></a>        "&lt;input type='</span>hidden<span class="string">' class='</span>searchtype<span class="string">' value='</span><span class="keyword">Or</span><span class="string">' />OR&lt;br />" +
<a name='L1098'></a>        searchnodehtml + "&lt;/div>";
<a name='L1099'></a>
<a name='L1100'></a>/**
<a name='L1101'></a> * The HTML code for a "deep" search node
<a name='L1102'></a> * @private
<a name='L1103'></a> * @constant
<a name='L1104'></a> */
<a name='L1105'></a>var searchdeepnodehtml = "&lt;div class='</span>searchnode searchdeepnode<span class="string">'>" +
<a name='L1106'></a>        "&lt;div class='</span>searchadddelbuttons<span class="string">'>" +
<a name='L1107'></a>        "&lt;input type='</span>button<span class="string">' class='</span>searchdelnodebut<span class="string">' value='</span>-<span class="string">' />" +
<a name='L1108'></a>        "&lt;/div>" +
<a name='L1109'></a>        "&lt;input type='</span>hidden<span class="string">' class='</span>searchtype<span class="string">' value='</span>Deep<span class="string">' />...&lt;br />" +
<a name='L1110'></a>        searchnodehtml + "&lt;/div>";
<a name='L1111'></a>
<a name='L1112'></a>/**
<a name='L1113'></a> * The HTML code for a "precedes" search node
<a name='L1114'></a> * @private
<a name='L1115'></a> * @constant
<a name='L1116'></a> */
<a name='L1117'></a>var searchprecnodehtml = "&lt;div class='</span>searchnode searchprecnode<span class="string">'>" +
<a name='L1118'></a>        "&lt;div class='</span>searchadddelbuttons<span class="string">'>" +
<a name='L1119'></a>        "&lt;input type='</span>button<span class="string">' class='</span>searchdelnodebut<span class="string">' value='</span>-<span class="string">' />" +
<a name='L1120'></a>        "&lt;/div>" +
<a name='L1121'></a>        "&lt;input type='</span>hidden<span class="string">' class='</span>searchtype<span class="string">' value='</span>Prec<span class="string">' />&amp;gt;&lt;br />" +
<a name='L1122'></a>        searchnodehtml + "&lt;/div>";
<a name='L1123'></a>
<a name='L1124'></a>/**
<a name='L1125'></a> * The HTML code for a node to add new search nodes
<a name='L1126'></a> * @private
<a name='L1127'></a> * @constant
<a name='L1128'></a> */
<a name='L1129'></a>var addsearchnodehtml = "&lt;div class='</span>newsearchnode<span class="string">'>" +
<a name='L1130'></a>        "&lt;input type='</span>hidden<span class="string">' class='</span>searchtype<span class="string">' value='</span>NewNode<span class="string">' />+" +
<a name='L1131'></a>        "&lt;/div>";
<a name='L1132'></a>
<a name='L1133'></a>/**
<a name='L1134'></a> * The HTML code for the default starting search node
<a name='L1135'></a> * @private
<a name='L1136'></a> * @constant
<a name='L1137'></a> */
<a name='L1138'></a>var searchhtml = "&lt;div id='</span>searchnodes<span class="string">' class='</span>searchnode<span class="string">'>&lt;input type='</span>hidden<span class="string">' " +
<a name='L1139'></a>        "class='</span>searchtype<span class="string">' value='</span>Root<span class="string">' />" + searchnodehtml + "&lt;/div>";
<a name='L1140'></a>
<a name='L1141'></a>/**
<a name='L1142'></a> * The last search
<a name='L1143'></a> *
<a name='L1144'></a> * So that it can be restored next time the dialog is opened.
<a name='L1145'></a> * @private
<a name='L1146'></a> */
<a name='L1147'></a>var savedsearch = $(searchhtml);
<a name='L1148'></a>
<a name='L1149'></a>addStartupHook(function () {
<a name='L1150'></a>    $("#butsearch").click(search);
<a name='L1151'></a>    $("#butnextmatch").click(nextSearchMatch);
<a name='L1152'></a>    $("#butclearmatch").click(clearSearchMatches);
<a name='L1153'></a>    $("#matchcommands").hide();
<a name='L1154'></a>});
<a name='L1155'></a>
<a name='L1156'></a>// =============== Event handlers
<a name='L1157'></a>
<a name='L1158'></a>/**
<a name='L1159'></a> * Clear the highlighting from search matches.
<a name='L1160'></a> */
<a name='L1161'></a>function clearSearchMatches() {
<a name='L1162'></a>    $(".searchmatch").removeClass("searchmatch");
<a name='L1163'></a>    $("#matchcommands").hide();
<a name='L1164'></a>}
<a name='L1165'></a>
<a name='L1166'></a>/**
<a name='L1167'></a> * Scroll down to the next node that matched a search.
<a name='L1168'></a> */
<a name='L1169'></a>function nextSearchMatch() {
<a name='L1170'></a>    scrollToNext(".searchmatch");
<a name='L1171'></a>}
<a name='L1172'></a>
<a name='L1173'></a>/**
<a name='L1174'></a> * Add a sibling search node
<a name='L1175'></a> * @private
<a name='L1176'></a> */
<a name='L1177'></a>function addSearchDaughter(e) {
<a name='L1178'></a>    var node = $(e.target).parents(".searchnode").first();
<a name='L1179'></a>    var newnode = $(searchnodehtml);
<a name='L1180'></a>    node.append(newnode);
<a name='L1181'></a>    searchNodePostAdd(newnode);
<a name='L1182'></a>}
<a name='L1183'></a>
<a name='L1184'></a>/**
<a name='L1185'></a> * Add a sibling search node
<a name='L1186'></a> * @private
<a name='L1187'></a> */
<a name='L1188'></a>function addSearchSibling(e) {
<a name='L1189'></a>    var node = $(e.target);
<a name='L1190'></a>    var newnode = $(searchnodehtml);
<a name='L1191'></a>    node.before(newnode);
<a name='L1192'></a>    searchNodePostAdd(newnode);
<a name='L1193'></a>}
<a name='L1194'></a>
<a name='L1195'></a>/**
<a name='L1196'></a> * Delete a search node
<a name='L1197'></a> * @private
<a name='L1198'></a> */
<a name='L1199'></a>function searchDelNode(e) {
<a name='L1200'></a>    var node = $(e.target).parents(".searchnode").first();
<a name='L1201'></a>    var tmp = $("#searchnodes").children(".searchnode:not(.newsearchnode)");
<a name='L1202'></a>    if (tmp.length == 1 &amp;&amp; tmp.is(node) &amp;&amp;
<a name='L1203'></a>        node.children(".searchnode").length == 0) {
<a name='L1204'></a>        displayWarning("Cannot remove only search term!");
<a name='L1205'></a>        return;
<a name='L1206'></a>    }
<a name='L1207'></a>    var child = node.children(".searchnode").first();
<a name='L1208'></a>    if (child.length == 1) {
<a name='L1209'></a>        node.contents(":not(.searchnode)").remove();
<a name='L1210'></a>        child.unwrap();
<a name='L1211'></a>    } else {
<a name='L1212'></a>        node.remove();
<a name='L1213'></a>    }
<a name='L1214'></a>    rejiggerSearchSiblingAdd();
<a name='L1215'></a>}
<a name='L1216'></a>
<a name='L1217'></a>/**
<a name='L1218'></a> * Add an "or" search node
<a name='L1219'></a> * @private
<a name='L1220'></a> */
<a name='L1221'></a>function searchOrNode(e) {
<a name='L1222'></a>    var node = $(e.target).parents(".searchnode").first();
<a name='L1223'></a>    var newnode = $(searchornodehtml);
<a name='L1224'></a>    node.replaceWith(newnode);
<a name='L1225'></a>    newnode.children(".searchnode").replaceWith(node);
<a name='L1226'></a>    searchNodePostAdd(newnode);
<a name='L1227'></a>}
<a name='L1228'></a>
<a name='L1229'></a>/**
<a name='L1230'></a> * Add a "deep" search node
<a name='L1231'></a> * @private
<a name='L1232'></a> */
<a name='L1233'></a>function searchDeepNode(e) {
<a name='L1234'></a>    var node = $(e.target).parents(".searchnode").first();
<a name='L1235'></a>    var newnode = $(searchdeepnodehtml);
<a name='L1236'></a>    node.append(newnode);
<a name='L1237'></a>    searchNodePostAdd(newnode);
<a name='L1238'></a>}
<a name='L1239'></a>
<a name='L1240'></a>/**
<a name='L1241'></a> * Add a "precedes" search node
<a name='L1242'></a> * @private
<a name='L1243'></a> */
<a name='L1244'></a>function searchPrecNode(e) {
<a name='L1245'></a>    var node = $(e.target).parents(".searchnode").first();
<a name='L1246'></a>    var newnode = $(searchprecnodehtml);
<a name='L1247'></a>    node.after(newnode);
<a name='L1248'></a>    searchNodePostAdd(newnode);
<a name='L1249'></a>}
<a name='L1250'></a>
<a name='L1251'></a>// =============== Helper functions
<a name='L1252'></a>
<a name='L1253'></a>/**
<a name='L1254'></a> * Indicate that a node matches a search
<a name='L1255'></a> *
<a name='L1256'></a> * @param {DOM node} node the node to flag
<a name='L1257'></a> */
<a name='L1258'></a>function flagSearchMatch(node) {
<a name='L1259'></a>    $(node).addClass("searchmatch");
<a name='L1260'></a>    $("#matchcommands").show();
<a name='L1261'></a>}
<a name='L1262'></a>
<a name='L1263'></a>/**
<a name='L1264'></a> * Hook up event handlers after adding a node to the search dialog
<a name='L1265'></a> */
<a name='L1266'></a>function searchNodePostAdd(node) {
<a name='L1267'></a>    $(".searchnewnodebut").unbind("click").click(addSearchDaughter);
<a name='L1268'></a>    $(".searchdelnodebut").unbind("click").click(searchDelNode);
<a name='L1269'></a>    $(".searchdeepnodebut").unbind("click").click(searchDeepNode);
<a name='L1270'></a>    $(".searchornodebut").unbind("click").click(searchOrNode);
<a name='L1271'></a>    $(".searchprecnodebut").unbind("click").click(searchPrecNode);
<a name='L1272'></a>    rejiggerSearchSiblingAdd();
<a name='L1273'></a>    var nodeToFocus = (node &amp;&amp; node.find(".searchtext")) ||
<a name='L1274'></a>            $(".searchtext").first();
<a name='L1275'></a>    nodeToFocus.focus();
<a name='L1276'></a>}
<a name='L1277'></a>
<a name='L1278'></a>/**
<a name='L1279'></a> * Recalculate the position of nodes that add siblings in the search dialog.
<a name='L1280'></a> * @private
<a name='L1281'></a> */
<a name='L1282'></a>function rejiggerSearchSiblingAdd() {
<a name='L1283'></a>    $(".newsearchnode").remove();
<a name='L1284'></a>    $(".searchnode").map(function() {
<a name='L1285'></a>        $(this).children(".searchnode").last().after(addsearchnodehtml);
<a name='L1286'></a>    });
<a name='L1287'></a>    $(".newsearchnode").click(addSearchSibling);
<a name='L1288'></a>}
<a name='L1289'></a>
<a name='L1290'></a>/**
<a name='L1291'></a> * Remember the currently-entered search, in order to restore it subsequently.
<a name='L1292'></a> * @private
<a name='L1293'></a> */
<a name='L1294'></a>function saveSearch() {
<a name='L1295'></a>    savedsearch = $("#searchnodes").clone();
<a name='L1296'></a>    var savedselects = savedsearch.find("select");
<a name='L1297'></a>    var origselects = $("#searchnodes").find("select");
<a name='L1298'></a>    savedselects.map(function (i) {
<a name='L1299'></a>        $(this).val(origselects.eq(i).val());
<a name='L1300'></a>    });
<a name='L1301'></a>}
<a name='L1302'></a>
<a name='L1303'></a>/**
<a name='L1304'></a> * Perform the search as entered in the dialog
<a name='L1305'></a> * @private
<a name='L1306'></a> */
<a name='L1307'></a>function doSearch () {
<a name='L1308'></a>    // TODO: need to save val of incremental acorss searches
<a name='L1309'></a>    clearSearchMatches();
<a name='L1310'></a>    var searchnodes = $("#searchnodes");
<a name='L1311'></a>    saveSearch();
<a name='L1312'></a>    hideDialogBox();
<a name='L1313'></a>    var searchCtx = $(".snode"); // TODO: remove sn0
<a name='L1314'></a>    var incremental = $("#searchInc").attr("checked");
<a name='L1315'></a>
<a name='L1316'></a>    if (incremental &amp;&amp; $(".searchmatch").length > 0) {
<a name='L1317'></a>        var lastMatchTop = $(".searchmatch").last().offset().top;
<a name='L1318'></a>        searchCtx.filter(function () {
<a name='L1319'></a>            // TODO: do this with faster document position dom call
<a name='L1320'></a>            return $(this).offset().top > lastMatchTop;
<a name='L1321'></a>        });
<a name='L1322'></a>    }
<a name='L1323'></a>
<a name='L1324'></a>    for (var i = 0; i &lt; searchCtx.length; i++) {
<a name='L1325'></a>        var res = interpretSearchNode(searchnodes, searchCtx[i]);
<a name='L1326'></a>        if (res) {
<a name='L1327'></a>            flagSearchMatch(res);
<a name='L1328'></a>            if (incremental) {
<a name='L1329'></a>                break;
<a name='L1330'></a>            }
<a name='L1331'></a>        }
<a name='L1332'></a>    }
<a name='L1333'></a>    nextSearchMatch();
<a name='L1334'></a>}
<a name='L1335'></a>
<a name='L1336'></a>/**
<a name='L1337'></a> * Clear any previous search, reverting the dialog back to its default state.
<a name='L1338'></a> * @private
<a name='L1339'></a> */
<a name='L1340'></a>function clearSearch() {
<a name='L1341'></a>    savedsearch = $(searchhtml);
<a name='L1342'></a>    $("#searchnodes").replaceWith(savedsearch);
<a name='L1343'></a>    searchNodePostAdd();
<a name='L1344'></a>}
<a name='L1345'></a>
<a name='L1346'></a>// =============== Search interpretation function
<a name='L1347'></a>
<a name='L1348'></a>/**
<a name='L1349'></a> * Interpret the DOM nodes comprising the search dialog.
<a name='L1350'></a> *
<a name='L1351'></a> * This function is treponsible for transforming the representation of a
<a name='L1352'></a> * search query as HTML into an executable query, and matching it against a
<a name='L1353'></a> * node.
<a name='L1354'></a> * @private
<a name='L1355'></a> *
<a name='L1356'></a> * @param {DOM node} node the search node to interpret
<a name='L1357'></a> * @param {DOM node} target the tree node to match it against
<a name='L1358'></a> * @param {Object} options search options
<a name='L1359'></a> * @returns {DOM node} `target` if it matched the query, otherwise `undefined`
<a name='L1360'></a> */
<a name='L1361'></a> 
<a name='L1362'></a>function interpretSearchNode(node, target, options) {
<a name='L1363'></a>    // TODO: optimize to remove jquery calls, only use regex matching if needed
<a name='L1364'></a>    // TODO: make case sensitivity an option?
<a name='L1365'></a>    options = options || {};
<a name='L1366'></a>    var searchtype = $(node).children(".searchtype").val();
<a name='L1367'></a>    var rx, hasMatch, i, j;
<a name='L1368'></a>    var newTarget = $(target).children();
<a name='L1369'></a>    var childSearches = $(node).children(".searchnode");
<a name='L1370'></a>
<a name='L1371'></a>    if ($(node).parent().is("#searchnodes") &amp;&amp;
<a name='L1372'></a>        !$("#searchnodes").children(".searchnode").first().is(node) &amp;&amp;
<a name='L1373'></a>        !options['</span>norecurse<span class="string">']) {
<a name='L1374'></a>        // special case siblings at root level
<a name='L1375'></a>        // What an ugly hack, can it be improved?
<a name='L1376'></a>        newTarget = $(target).siblings();
<a name='L1377'></a>        for (j = 0; j &lt; newTarget.length; j++) {
<a name='L1378'></a>            if (interpretSearchNode(node, newTarget[j], { norecurse: true })) {
<a name='L1379'></a>                return target;
<a name='L1380'></a>            }
<a name='L1381'></a>        }
<a name='L1382'></a>    }
<a name='L1383'></a>
<a name='L1384'></a>    if (searchtype == "Label") {
<a name='L1385'></a>        rx = RegExp("^" + $(node).children(".searchtext").val(), "i");
<a name='L1386'></a>        hasMatch = $(target).hasClass("snode") &amp;&amp; rx.test(getLabel($(target)));
<a name='L1387'></a>        if (!hasMatch) {
<a name='L1388'></a>            return undefined;
<a name='L1389'></a>        }
<a name='L1390'></a>    } else if (searchtype == "Text") {
<a name='L1391'></a>        rx = RegExp("^" + $(node).children(".searchtext").val(), "i");
<a name='L1392'></a>        hasMatch = $(target).children(".wnode").length == 1 &amp;&amp;
<a name='L1393'></a>            rx.test(wnodeString($(target)));
<a name='L1394'></a>        if (!hasMatch) {
<a name='L1395'></a>            return undefined;
<a name='L1396'></a>        }
<a name='L1397'></a>    } else if (searchtype == "Root") {
<a name='L1398'></a>        newTarget = $(target);
<a name='L1399'></a>    } else if (searchtype == "Or") {
<a name='L1400'></a>        for (i = 0; i &lt; childSearches.length; i++) {
<a name='L1401'></a>            if (interpretSearchNode(childSearches[i], target)) {
<a name='L1402'></a>                return target;
<a name='L1403'></a>            }
<a name='L1404'></a>        }
<a name='L1405'></a>        return undefined;
<a name='L1406'></a>    } else if (searchtype == "Deep") {
<a name='L1407'></a>        newTarget = $(target).find(".snode,.wnode");
<a name='L1408'></a>    } else if (searchtype == "Prec") {
<a name='L1409'></a>        newTarget = $(target).nextAll();
<a name='L1410'></a>    }
<a name='L1411'></a>
<a name='L1412'></a>    for (i = 0; i &lt; childSearches.length; i++) {
<a name='L1413'></a>        var succ = false;
<a name='L1414'></a>        for (j = 0; j &lt; newTarget.length; j++) {
<a name='L1415'></a>            if (interpretSearchNode(childSearches[i], newTarget[j])) {
<a name='L1416'></a>                succ = true;
<a name='L1417'></a>                break;
<a name='L1418'></a>            }
<a name='L1419'></a>        }
<a name='L1420'></a>        if (!succ) {
<a name='L1421'></a>            return undefined;
<a name='L1422'></a>        }
<a name='L1423'></a>    }
<a name='L1424'></a>
<a name='L1425'></a>    return target;
<a name='L1426'></a>}
<a name='L1427'></a>
<a name='L1428'></a>// =============== The core search function
<a name='L1429'></a>
<a name='L1430'></a>/**
<a name='L1431'></a> * Display a search dialog.
<a name='L1432'></a> */
<a name='L1433'></a>function search() {
<a name='L1434'></a>    var html = "&lt;div id='</span>searchnodes<span class="string">' />" +
<a name='L1435'></a>            "&lt;div id='</span>dialogButtons<span class="string">'>&lt;label for='</span>searchInc<span class="string">'>Incremental: " +
<a name='L1436'></a>            "&lt;/label>&lt;input id='</span>searchInc<span class="string">' name='</span>searchInc<span class="string">' type='</span>checkbox<span class="string">' />" +
<a name='L1437'></a>            // TODO: it seems that any plausible implementation of search is
<a name='L1438'></a>            // going to use rx, so it doesn'</span>t make sense to turn it off
<a name='L1439'></a>            <span class="comment">// "&lt;label for='searchRE'>Regex: &lt;/label>" +</span>
<a name='L1440'></a>            <span class="comment">// "&lt;input id='searchRE' name='searchRE' type='checkbox' />" +</span>
<a name='L1441'></a>            <span class="string">"&lt;input id='clearSearch' type='button' value='Clear' />"</span> +
<a name='L1442'></a>            <span class="string">"&lt;input id='doSearch' type='button' value='Search' />&lt;/div>"</span>;
<a name='L1443'></a>    showDialogBox(<span class="string">"Search"</span>, html, doSearch, saveSearch);
<a name='L1444'></a>    $(<span class="string">"#searchnodes"</span>).replaceWith(savedsearch);
<a name='L1445'></a>    $(<span class="string">"#doSearch"</span>).click(doSearch);
<a name='L1446'></a>    $(<span class="string">"#clearSearch"</span>).click(clearSearch);
<a name='L1447'></a>    searchNodePostAdd();
<a name='L1448'></a>}
<a name='L1449'></a>
<a name='L1450'></a><span class="comment">// ===== Tree manipulations</span>
<a name='L1451'></a>
<a name='L1452'></a><span class="comment">// ========== Movement</span>
<a name='L1453'></a>
<a name='L1454'></a><span class="comment">/**
<a name='L1455'></a> * Move the selected node(s) to a new position.
<a name='L1456'></a> *
<a name='L1457'></a> * The movement operation must not change the text of the token.
<a name='L1458'></a> *
<a name='L1459'></a> *<span class="phpdoc"> @param</span> {DOM Node} parent the parent node to move selection under
<a name='L1460'></a> *
<a name='L1461'></a> *<span class="phpdoc"> @returns</span> {Boolean} whether the operation was successful
<a name='L1462'></a> */</span>
<a name='L1463'></a><span class="keyword">function</span> moveNode(<span class="keyword">parent</span>) {
<a name='L1464'></a>    <span class="keyword">var</span> parent_ip = $(startnode).parents(<span class="string">"#sn0>.snode,#sn0"</span>).first();
<a name='L1465'></a>    <span class="keyword">var</span> other_parent = $(<span class="keyword">parent</span>).parents(<span class="string">"#sn0>.snode,#sn0"</span>).first();
<a name='L1466'></a>    <span class="keyword">if</span> (<span class="keyword">parent</span> == document.getElementById(<span class="string">"sn0"</span>) ||
<a name='L1467'></a>        !parent_ip.is(other_parent)) {
<a name='L1468'></a>        parent_ip = $(<span class="string">"#sn0"</span>);
<a name='L1469'></a>    }
<a name='L1470'></a>    <span class="keyword">var</span> parent_before;
<a name='L1471'></a>    <span class="keyword">var</span> textbefore = currentText(parent_ip);
<a name='L1472'></a>    <span class="keyword">var</span> nodeMoved;
<a name='L1473'></a>    <span class="keyword">if</span> (!isPossibleTarget(<span class="keyword">parent</span>) || <span class="comment">// can't move under a tag node</span>
<a name='L1474'></a>        $(startnode).<span class="keyword">parent</span>().children().length == <span class="number">1</span> || <span class="comment">// can't move an only child</span>
<a name='L1475'></a>        $(<span class="keyword">parent</span>).parents().is(startnode) <span class="comment">// can't move under one's own child</span>
<a name='L1476'></a>       )
<a name='L1477'></a>    {
<a name='L1478'></a>        clearSelection();
<a name='L1479'></a>        <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L1480'></a>    } <span class="keyword">else</span> <span class="keyword">if</span> ($(startnode).parents().is(<span class="keyword">parent</span>)) {
<a name='L1481'></a>        <span class="comment">// move up if moving to a node that is already my parent</span>
<a name='L1482'></a>        <span class="keyword">if</span> ($(startnode).<span class="keyword">parent</span>().children().first().is(startnode)) {
<a name='L1483'></a>            <span class="keyword">if</span> ($(startnode).parentsUntil(<span class="keyword">parent</span>).slice(<span class="number">0</span>,-<span class="number">1</span>).
<a name='L1484'></a>                filter(<span class="string">":not(:first-child)"</span>).size() > <span class="number">0</span>) {
<a name='L1485'></a>                clearSelection();
<a name='L1486'></a>                <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L1487'></a>            }
<a name='L1488'></a>            <span class="keyword">if</span> (<span class="keyword">parent</span> == document.getElementById(<span class="string">"sn0"</span>)) {
<a name='L1489'></a>                touchTree($(startnode));
<a name='L1490'></a>                registerNewRootTree($(startnode));
<a name='L1491'></a>            } <span class="keyword">else</span> {
<a name='L1492'></a>                touchTree($(startnode));
<a name='L1493'></a>            }
<a name='L1494'></a>            $(startnode).insertBefore($(<span class="keyword">parent</span>).children().filter(
<a name='L1495'></a>                                                 $(startnode).parents()));
<a name='L1496'></a>            <span class="keyword">if</span> (currentText(parent_ip) != textbefore) {
<a name='L1497'></a>                alert(<span class="string">"failed what should have been a strict test"</span>);
<a name='L1498'></a>            }
<a name='L1499'></a>        } <span class="keyword">else</span> <span class="keyword">if</span> ($(startnode).<span class="keyword">parent</span>().children().last().is(startnode)) {
<a name='L1500'></a>            <span class="keyword">if</span> ($(startnode).parentsUntil(<span class="keyword">parent</span>).slice(<span class="number">0</span>,-<span class="number">1</span>).
<a name='L1501'></a>                filter(<span class="string">":not(:last-child)"</span>).size() > <span class="number">0</span>) {
<a name='L1502'></a>                clearSelection();
<a name='L1503'></a>                <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L1504'></a>            }
<a name='L1505'></a>            <span class="keyword">if</span> (<span class="keyword">parent</span> == document.getElementById(<span class="string">"sn0"</span>)) {
<a name='L1506'></a>                touchTree($(startnode));
<a name='L1507'></a>                registerNewRootTree($(startnode));
<a name='L1508'></a>            } <span class="keyword">else</span> {
<a name='L1509'></a>                touchTree($(startnode));
<a name='L1510'></a>            }
<a name='L1511'></a>            $(startnode).insertAfter($(<span class="keyword">parent</span>).children().
<a name='L1512'></a>                                     filter($(startnode).parents()));
<a name='L1513'></a>            <span class="keyword">if</span> (currentText(parent_ip) != textbefore) {
<a name='L1514'></a>                alert(<span class="string">"failed what should have been a strict test"</span>);
<a name='L1515'></a>            }
<a name='L1516'></a>        } <span class="keyword">else</span> {
<a name='L1517'></a>            <span class="comment">// cannot move from this position</span>
<a name='L1518'></a>            clearSelection();
<a name='L1519'></a>            <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L1520'></a>        }
<a name='L1521'></a>    } <span class="keyword">else</span> {
<a name='L1522'></a>        <span class="comment">// otherwise move under my sister</span>
<a name='L1523'></a>        <span class="keyword">var</span> tokenMerge = isRootNode( $(startnode) );
<a name='L1524'></a>        <span class="keyword">var</span> maxindex = maxIndex(getTokenRoot($(<span class="keyword">parent</span>)));
<a name='L1525'></a>        <span class="keyword">var</span> movednode = $(startnode);
<a name='L1526'></a>
<a name='L1527'></a>        <span class="comment">// NOTE: currently there are no more stringent checks below; if that</span>
<a name='L1528'></a>        <span class="comment">// changes, we might want to demote this</span>
<a name='L1529'></a>        parent_before = parent_ip.<span class="keyword">clone</span>();
<a name='L1530'></a>
<a name='L1531'></a>        <span class="comment">// where a and b are DOM elements (not jquery-wrapped),</span>
<a name='L1532'></a>        <span class="comment">// a.compareDocumentPosition(b) returns an integer.  The first (counting</span>
<a name='L1533'></a>        <span class="comment">// from 0) bit is set if B precedes A, and the second bit is set if A</span>
<a name='L1534'></a>        <span class="comment">// precedes B.</span>
<a name='L1535'></a>
<a name='L1536'></a>        <span class="comment">// TODO: perhaps here and in the immediately following else if it is</span>
<a name='L1537'></a>        <span class="comment">// possible to simplify and remove the compareDocumentPosition call,</span>
<a name='L1538'></a>        <span class="comment">// since the jQuery subsumes it</span>
<a name='L1539'></a>        <span class="keyword">if</span> (<span class="keyword">parent</span>.compareDocumentPosition(startnode) &amp; <span class="number">0x4</span>) {
<a name='L1540'></a>            <span class="comment">// check whether the nodes are adjacent.  Ideally, we would like</span>
<a name='L1541'></a>            <span class="comment">// to say selfAndParentsUntil, but no such jQuery fn exists, thus</span>
<a name='L1542'></a>            <span class="comment">// necessitating the disjunction.</span>
<a name='L1543'></a>            <span class="comment">// TODO: too strict</span>
<a name='L1544'></a>            <span class="comment">// &amp;&amp;</span>
<a name='L1545'></a>            <span class="comment">// $(startnode).prev().is(</span>
<a name='L1546'></a>            <span class="comment">//     $(parent).parentsUntil(startnode.parentNode).last()) ||</span>
<a name='L1547'></a>            <span class="comment">// $(startnode).prev().is(parent)</span>
<a name='L1548'></a>
<a name='L1549'></a>            <span class="comment">// parent precedes startnode</span>
<a name='L1550'></a>            undoBeginTransaction();
<a name='L1551'></a>            <span class="keyword">if</span> (tokenMerge) {
<a name='L1552'></a>                registerDeletedRootTree($(startnode));
<a name='L1553'></a>                touchTree($(<span class="keyword">parent</span>));
<a name='L1554'></a>                <span class="comment">// TODO: this will bomb if we are merging more than 2 tokens</span>
<a name='L1555'></a>                <span class="comment">// by multiple selection.</span>
<a name='L1556'></a>                addToIndices(movednode, maxindex);
<a name='L1557'></a>            } <span class="keyword">else</span> {
<a name='L1558'></a>                touchTree($(startnode));
<a name='L1559'></a>                touchTree($(<span class="keyword">parent</span>));
<a name='L1560'></a>            }
<a name='L1561'></a>            movednode.appendTo(<span class="keyword">parent</span>);
<a name='L1562'></a>            <span class="keyword">if</span> (currentText(parent_ip) != textbefore)  {
<a name='L1563'></a>                undoAbortTransaction();
<a name='L1564'></a>                parent_ip.replaceWith(parent_before);
<a name='L1565'></a>                <span class="keyword">if</span> (parent_ip.attr(<span class="string">"id"</span>) == <span class="string">"sn0"</span>) {
<a name='L1566'></a>                    $(<span class="string">"#sn0"</span>).mousedown(handleNodeClick);
<a name='L1567'></a>                }
<a name='L1568'></a>                clearSelection();
<a name='L1569'></a>                <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L1570'></a>            } <span class="keyword">else</span> {
<a name='L1571'></a>                undoEndTransaction();
<a name='L1572'></a>            }
<a name='L1573'></a>        } <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="keyword">parent</span>.compareDocumentPosition(startnode) &amp; <span class="number">0x2</span>)) {
<a name='L1574'></a>            <span class="comment">// &amp;&amp;</span>
<a name='L1575'></a>            <span class="comment">// $(startnode).next().is(</span>
<a name='L1576'></a>            <span class="comment">//     $(parent).parentsUntil(startnode.parentNode).last()) ||</span>
<a name='L1577'></a>            <span class="comment">// $(startnode).next().is(parent)</span>
<a name='L1578'></a>
<a name='L1579'></a>            <span class="comment">// startnode precedes parent</span>
<a name='L1580'></a>            undoBeginTransaction();
<a name='L1581'></a>            <span class="keyword">if</span> (tokenMerge) {
<a name='L1582'></a>                registerDeletedRootTree($(startnode));
<a name='L1583'></a>                touchTree($(<span class="keyword">parent</span>));
<a name='L1584'></a>                addToIndices(movednode, maxindex);
<a name='L1585'></a>            } <span class="keyword">else</span> {
<a name='L1586'></a>                touchTree($(startnode));
<a name='L1587'></a>                touchTree($(<span class="keyword">parent</span>));
<a name='L1588'></a>            }
<a name='L1589'></a>            movednode.insertBefore($(<span class="keyword">parent</span>).children().first());
<a name='L1590'></a>            <span class="keyword">if</span> (currentText(parent_ip) != textbefore) {
<a name='L1591'></a>                undoAbortTransaction();
<a name='L1592'></a>                parent_ip.replaceWith(parent_before);
<a name='L1593'></a>                <span class="keyword">if</span> (parent_ip == <span class="string">"sn0"</span>) {
<a name='L1594'></a>                    $(<span class="string">"#sn0"</span>).mousedown(handleNodeClick);
<a name='L1595'></a>                }
<a name='L1596'></a>                clearSelection();
<a name='L1597'></a>                <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L1598'></a>            } <span class="keyword">else</span> {
<a name='L1599'></a>                undoEndTransaction();
<a name='L1600'></a>            }
<a name='L1601'></a>        } <span class="comment">// TODO: conditional branches not exhaustive</span>
<a name='L1602'></a>    }
<a name='L1603'></a>    clearSelection();
<a name='L1604'></a>    <span class="keyword">return</span> <span class="keyword">true</span>;
<a name='L1605'></a>}
<a name='L1606'></a>
<a name='L1607'></a><span class="comment">/**
<a name='L1608'></a> * Move several nodes.
<a name='L1609'></a> *
<a name='L1610'></a> * The two selected nodes must be sisters, and they and all intervening sisters
<a name='L1611'></a> * will be moved as a unit.  Calls {@link moveNode} to do the heavy lifting.
<a name='L1612'></a> *
<a name='L1613'></a> *<span class="phpdoc"> @param</span> {DOM Node} parent the parent to move the selection under
<a name='L1614'></a> */</span>
<a name='L1615'></a><span class="keyword">function</span> moveNodes(<span class="keyword">parent</span>) {
<a name='L1616'></a>    <span class="keyword">if</span> (!startnode || !endnode) {
<a name='L1617'></a>        <span class="keyword">return</span>;
<a name='L1618'></a>    }
<a name='L1619'></a>    undoBeginTransaction();
<a name='L1620'></a>    touchTree($(startnode));
<a name='L1621'></a>    touchTree($(<span class="keyword">parent</span>));
<a name='L1622'></a>    <span class="keyword">if</span> (startnode.compareDocumentPosition(endnode) &amp; <span class="number">0x2</span>) {
<a name='L1623'></a>        <span class="comment">// endnode precedes startnode, reverse them</span>
<a name='L1624'></a>        <span class="keyword">var</span> temp = startnode;
<a name='L1625'></a>        startnode = endnode;
<a name='L1626'></a>        endnode = temp;
<a name='L1627'></a>    }
<a name='L1628'></a>    <span class="keyword">if</span> (startnode.parentNode == endnode.parentNode) {
<a name='L1629'></a>        <span class="comment">// collect startnode and its sister up until endnode</span>
<a name='L1630'></a>        $(startnode).add($(startnode).nextUntil(endnode)).
<a name='L1631'></a>            add(endnode).
<a name='L1632'></a>            wrapAll(<span class="string">'&lt;div xxx="newnode" class="snode">XP&lt;/div>'</span>);
<a name='L1633'></a>
<a name='L1634'></a>    } <span class="keyword">else</span> {
<a name='L1635'></a>        <span class="keyword">return</span>; <span class="comment">// they are not sisters</span>
<a name='L1636'></a>    }
<a name='L1637'></a>    <span class="keyword">var</span> toselect = $(<span class="string">".snode[xxx=newnode]"</span>).first();
<a name='L1638'></a>    toselect = toselect.get(<span class="number">0</span>);
<a name='L1639'></a>    <span class="comment">// BUG when making XP and then use context menu: TODO XXX</span>
<a name='L1640'></a>
<a name='L1641'></a>    startnode = toselect;
<a name='L1642'></a>    <span class="keyword">var</span> res = ignoringUndo(<span class="keyword">function</span> () { moveNode(<span class="keyword">parent</span>); });
<a name='L1643'></a>    <span class="keyword">if</span> (res) {
<a name='L1644'></a>        undoEndTransaction();
<a name='L1645'></a>    } <span class="keyword">else</span> {
<a name='L1646'></a>        undoAbortTransaction();
<a name='L1647'></a>    }
<a name='L1648'></a>    startnode = $(<span class="string">".snode[xxx=newnode]"</span>).first().get(<span class="number">0</span>);
<a name='L1649'></a>    endnode = undefined;
<a name='L1650'></a>    pruneNode();
<a name='L1651'></a>    clearSelection();
<a name='L1652'></a>}
<a name='L1653'></a>
<a name='L1654'></a><span class="comment">// ========== Creation</span>
<a name='L1655'></a>
<a name='L1656'></a><span class="comment">/**
<a name='L1657'></a> * Create a leaf node before the selected node.
<a name='L1658'></a> *
<a name='L1659'></a> * Uses heuristic to determine whether the new leaf is to be a trace, empty
<a name='L1660'></a> * subject, etc.
<a name='L1661'></a> */</span>
<a name='L1662'></a><span class="keyword">function</span> leafBefore() {
<a name='L1663'></a>    makeLeaf(<span class="keyword">true</span>);
<a name='L1664'></a>}
<a name='L1665'></a>
<a name='L1666'></a><span class="comment">/**
<a name='L1667'></a> * Create a leaf node after the selected node.
<a name='L1668'></a> *
<a name='L1669'></a> * Uses heuristic to determine whether the new leaf is to be a trace, empty
<a name='L1670'></a> * subject, etc.
<a name='L1671'></a> */</span>
<a name='L1672'></a><span class="keyword">function</span> leafAfter() {
<a name='L1673'></a>    makeLeaf(<span class="keyword">false</span>);
<a name='L1674'></a>}
<a name='L1675'></a>
<a name='L1676'></a><span class="comment">// TODO: the hardcoding of defaults in this function is ugly.  We should</span>
<a name='L1677'></a><span class="comment">// supply a default heuristic fn to try to guess these, then allow</span>
<a name='L1678'></a><span class="comment">// settings.js to override it.</span>
<a name='L1679'></a>
<a name='L1680'></a><span class="comment">// TODO: maybe put the heuristic into leafbefore/after, and leave this fn clean?</span>
<a name='L1681'></a>
<a name='L1682'></a><span class="comment">/**
<a name='L1683'></a> * Create a leaf node adjacent to the selection, or a given target.
<a name='L1684'></a> *
<a name='L1685'></a> *<span class="phpdoc"> @param</span> {Boolean} before whether to create the node before or after selection
<a name='L1686'></a> *<span class="phpdoc"> @param</span> {String} label the label to give the new node
<a name='L1687'></a> *<span class="phpdoc"> @param</span> {String} word the text to give the new node
<a name='L1688'></a> *<span class="phpdoc"> @param</span> {DOM Node} target where to put the new node (default: selected node)
<a name='L1689'></a> */</span>
<a name='L1690'></a><span class="keyword">function</span> makeLeaf(before, label, word, target) {
<a name='L1691'></a>    <span class="keyword">if</span> (!(target || startnode)) <span class="keyword">return</span>;
<a name='L1692'></a>
<a name='L1693'></a>    <span class="keyword">if</span> (!label) {
<a name='L1694'></a>        label = <span class="string">"NP-SBJ"</span>;
<a name='L1695'></a>    }
<a name='L1696'></a>    <span class="keyword">if</span> (!word) {
<a name='L1697'></a>        word = <span class="string">"*con*"</span>;
<a name='L1698'></a>    }
<a name='L1699'></a>    <span class="keyword">if</span> (!target) {
<a name='L1700'></a>        target = startnode;
<a name='L1701'></a>    }
<a name='L1702'></a>
<a name='L1703'></a>    undoBeginTransaction();
<a name='L1704'></a>    <span class="keyword">var</span> isRootLevel = <span class="keyword">false</span>;
<a name='L1705'></a>    <span class="keyword">if</span> (isRootNode($(target))) {
<a name='L1706'></a>        isRootLevel = <span class="keyword">true</span>;
<a name='L1707'></a>    } <span class="keyword">else</span> {
<a name='L1708'></a>        touchTree($(target));
<a name='L1709'></a>    }
<a name='L1710'></a>
<a name='L1711'></a>    <span class="keyword">var</span> lemma = <span class="keyword">false</span>;
<a name='L1712'></a>    <span class="keyword">var</span> temp = word.split(<span class="string">"-"</span>);
<a name='L1713'></a>    <span class="keyword">if</span> (temp.length > <span class="number">1</span>) {
<a name='L1714'></a>        lemma = temp.pop();
<a name='L1715'></a>        word = temp.join(<span class="string">"-"</span>);
<a name='L1716'></a>    }
<a name='L1717'></a>
<a name='L1718'></a>    <span class="keyword">var</span> doCoindex = <span class="keyword">false</span>;
<a name='L1719'></a>
<a name='L1720'></a>    <span class="keyword">if</span> (endnode) {
<a name='L1721'></a>        <span class="keyword">var</span> startRoot = getTokenRoot($(startnode));
<a name='L1722'></a>        <span class="keyword">var</span> endRoot = getTokenRoot($(endnode));
<a name='L1723'></a>        <span class="keyword">if</span> (startRoot == endRoot) {
<a name='L1724'></a>            word = <span class="string">"*ICH*"</span>;
<a name='L1725'></a>            label = getLabel($(endnode));
<a name='L1726'></a>            <span class="keyword">if</span> (label.startsWith(<span class="string">"W"</span>)) {
<a name='L1727'></a>                word = <span class="string">"*T*"</span>;
<a name='L1728'></a>                label = label.substr(<span class="number">1</span>).replace(/-[<span class="number">0</span>-<span class="number">9</span>]+$/, <span class="string">""</span>);
<a name='L1729'></a>            } <span class="keyword">else</span> <span class="keyword">if</span> (label.split(<span class="string">"-"</span>).indexOf(<span class="string">"CL"</span>) > -<span class="number">1</span>) {
<a name='L1730'></a>                word = <span class="string">"*CL*"</span>;
<a name='L1731'></a>                label = getLabel($(endnode)).replace(<span class="string">"-CL"</span>, <span class="string">""</span>);
<a name='L1732'></a>                <span class="keyword">if</span> (label.substring(<span class="number">0</span>,<span class="number">3</span>) == <span class="string">"PRO"</span>) {
<a name='L1733'></a>                    label = <span class="string">"NP"</span>;
<a name='L1734'></a>                }
<a name='L1735'></a>            }
<a name='L1736'></a>            doCoindex = <span class="keyword">true</span>;
<a name='L1737'></a>        } <span class="keyword">else</span> { <span class="comment">// abort if selecting from different tokens</span>
<a name='L1738'></a>            undoAbortTransaction();
<a name='L1739'></a>            <span class="keyword">return</span>;
<a name='L1740'></a>        }
<a name='L1741'></a>    }
<a name='L1742'></a>
<a name='L1743'></a>    <span class="keyword">var</span> newleaf = <span class="string">"&lt;div class='snode "</span> + label + <span class="string">"'>"</span> + label +
<a name='L1744'></a>        <span class="string">"&lt;span class='wnode'>"</span> + word;
<a name='L1745'></a>    <span class="keyword">if</span> (lemma) {
<a name='L1746'></a>        newleaf += <span class="string">"&lt;span class='lemma'>-"</span> + lemma +
<a name='L1747'></a>            <span class="string">"&lt;/span>"</span>;
<a name='L1748'></a>    }
<a name='L1749'></a>    newleaf += <span class="string">"&lt;/span>&lt;/div>\n"</span>;
<a name='L1750'></a>    newleaf = $(newleaf);
<a name='L1751'></a>    <span class="keyword">if</span> (before) {
<a name='L1752'></a>        newleaf.insertBefore(target);
<a name='L1753'></a>    } <span class="keyword">else</span> {
<a name='L1754'></a>        newleaf.insertAfter(target);
<a name='L1755'></a>    }
<a name='L1756'></a>    <span class="keyword">if</span> (doCoindex) {
<a name='L1757'></a>        startnode = newleaf.get(<span class="number">0</span>);
<a name='L1758'></a>        coIndex();
<a name='L1759'></a>    }
<a name='L1760'></a>    startnode = <span class="keyword">null</span>;
<a name='L1761'></a>    endnode = <span class="keyword">null</span>;
<a name='L1762'></a>    selectNode(newleaf.get(<span class="number">0</span>));
<a name='L1763'></a>    updateSelection();
<a name='L1764'></a>    <span class="keyword">if</span> (isRootLevel) {
<a name='L1765'></a>        registerNewRootTree(newleaf);
<a name='L1766'></a>    }
<a name='L1767'></a>    undoEndTransaction();
<a name='L1768'></a>}
<a name='L1769'></a>
<a name='L1770'></a><span class="comment">/**
<a name='L1771'></a> * Create a phrasal node.
<a name='L1772'></a> *
<a name='L1773'></a> * The node will dominate the selected node or (if two sisters are selected)
<a name='L1774'></a> * the selection and all intervening sisters.
<a name='L1775'></a> *
<a name='L1776'></a> *<span class="phpdoc"> @param</span> {String} [label] the label to give the new node (default: XP)
<a name='L1777'></a> */</span>
<a name='L1778'></a><span class="keyword">function</span> makeNode(label) {
<a name='L1779'></a>    <span class="comment">// check if something is selected</span>
<a name='L1780'></a>    <span class="keyword">if</span> (!startnode) {
<a name='L1781'></a>        <span class="keyword">return</span>;
<a name='L1782'></a>    }
<a name='L1783'></a>    <span class="keyword">if</span> (!label) {
<a name='L1784'></a>        label = <span class="string">"XP"</span>;
<a name='L1785'></a>    }
<a name='L1786'></a>    <span class="keyword">var</span> rootLevel = isRootNode($(startnode));
<a name='L1787'></a>    undoBeginTransaction();
<a name='L1788'></a>    <span class="keyword">if</span> (rootLevel) {
<a name='L1789'></a>        registerDeletedRootTree($(startnode));
<a name='L1790'></a>    } <span class="keyword">else</span> {
<a name='L1791'></a>        touchTree($(startnode));
<a name='L1792'></a>    }
<a name='L1793'></a>    <span class="keyword">var</span> parent_ip = $(startnode).parents(<span class="string">"#sn0>.snode,#sn0"</span>).first();
<a name='L1794'></a>    <span class="keyword">var</span> parent_before = parent_ip.<span class="keyword">clone</span>();
<a name='L1795'></a>    <span class="comment">// make end = start if only one node is selected</span>
<a name='L1796'></a>    <span class="keyword">if</span> (!endnode) {
<a name='L1797'></a>        <span class="comment">// if only one node, wrap around that one</span>
<a name='L1798'></a>        $(startnode).wrapAll(<span class="string">'&lt;div xxx="newnode" class="snode '</span> + label + <span class="string">'">'</span>
<a name='L1799'></a>                             + label + <span class="string">' &lt;/div>\n'</span>);
<a name='L1800'></a>    } <span class="keyword">else</span> {
<a name='L1801'></a>        <span class="keyword">if</span> (startnode.compareDocumentPosition(endnode) &amp; <span class="number">0x2</span>) {
<a name='L1802'></a>            <span class="comment">// startnode and endnode in wrong order, reverse them</span>
<a name='L1803'></a>            <span class="keyword">var</span> temp = startnode;
<a name='L1804'></a>            startnode = endnode;
<a name='L1805'></a>            endnode = temp;
<a name='L1806'></a>        }
<a name='L1807'></a>
<a name='L1808'></a>        <span class="comment">// check if they are really sisters XXXXXXXXXXXXXXX</span>
<a name='L1809'></a>        <span class="keyword">if</span> ($(startnode).siblings().is(endnode)) {
<a name='L1810'></a>            <span class="comment">// then, collect startnode and its sister up until endnode</span>
<a name='L1811'></a>            <span class="keyword">var</span> oldtext = currentText(parent_ip);
<a name='L1812'></a>            $(startnode).add($(startnode).nextUntil(endnode)).add(
<a name='L1813'></a>                endnode).wrapAll(<span class="string">'&lt;div xxx="newnode" class="snode '</span> +
<a name='L1814'></a>                                        label + <span class="string">'">'</span> + label + <span class="string">' &lt;/div>\n'</span>);
<a name='L1815'></a>            <span class="comment">// undo if this messed up the text order</span>
<a name='L1816'></a>            <span class="keyword">if</span>(currentText(parent_ip) != oldtext) {
<a name='L1817'></a>                <span class="comment">// TODO: is this plausible? can we remove the check?</span>
<a name='L1818'></a>                parent_ip.replaceWith(parent_before);
<a name='L1819'></a>                undoAbortTransaction();
<a name='L1820'></a>                clearSelection();
<a name='L1821'></a>                <span class="keyword">return</span>;
<a name='L1822'></a>            }
<a name='L1823'></a>        }
<a name='L1824'></a>    }
<a name='L1825'></a>
<a name='L1826'></a>    startnode = <span class="keyword">null</span>;
<a name='L1827'></a>    endnode = <span class="keyword">null</span>;
<a name='L1828'></a>
<a name='L1829'></a>    <span class="keyword">var</span> toselect = $(<span class="string">".snode[xxx=newnode]"</span>).first();
<a name='L1830'></a>
<a name='L1831'></a>    <span class="keyword">if</span> (rootLevel) {
<a name='L1832'></a>        registerNewRootTree(toselect);
<a name='L1833'></a>    }
<a name='L1834'></a>
<a name='L1835'></a>    undoEndTransaction();
<a name='L1836'></a>
<a name='L1837'></a>    <span class="comment">// BUG when making XP and then use context menu: todo XXX</span>
<a name='L1838'></a>
<a name='L1839'></a>    selectNode(toselect.get(<span class="number">0</span>));
<a name='L1840'></a>    toselect.attr(<span class="string">"xxx"</span>,<span class="keyword">null</span>);
<a name='L1841'></a>    updateSelection();
<a name='L1842'></a>    <span class="comment">// toselect.mousedown(handleNodeClick);</span>
<a name='L1843'></a>}
<a name='L1844'></a>
<a name='L1845'></a><span class="comment">// ========== Deletion</span>
<a name='L1846'></a>
<a name='L1847'></a><span class="comment">/**
<a name='L1848'></a> * Delete a node.
<a name='L1849'></a> *
<a name='L1850'></a> * The node can only be deleted if doing so does not affect the text, i.e. it
<a name='L1851'></a> * directly dominates no non-empty terminals.
<a name='L1852'></a> */</span>
<a name='L1853'></a><span class="keyword">function</span> pruneNode() {
<a name='L1854'></a>    <span class="keyword">if</span> (startnode &amp;&amp; !endnode) {
<a name='L1855'></a>        <span class="keyword">var</span> deltext = $(startnode).children().first().text();
<a name='L1856'></a>        <span class="keyword">if</span> (isLeafNode(startnode) &amp;&amp; isEmpty(deltext)) {
<a name='L1857'></a>            <span class="comment">// it is ok to delete leaf if it is empty/trace</span>
<a name='L1858'></a>            <span class="keyword">if</span> (isRootNode($(startnode))) {
<a name='L1859'></a>                <span class="comment">// perversely, it is possible to have a leaf node at the root</span>
<a name='L1860'></a>                <span class="comment">// of a file.</span>
<a name='L1861'></a>                registerDeletedRootTree($(startnode));
<a name='L1862'></a>            } <span class="keyword">else</span> {
<a name='L1863'></a>                touchTree($(startnode));
<a name='L1864'></a>            }
<a name='L1865'></a>            $(startnode).remove();
<a name='L1866'></a>            startnode = endnode = <span class="keyword">null</span>;
<a name='L1867'></a>            updateSelection();
<a name='L1868'></a>            <span class="keyword">return</span>;
<a name='L1869'></a>        } <span class="keyword">else</span> <span class="keyword">if</span> (isLeafNode(startnode)) {
<a name='L1870'></a>            <span class="comment">// but other leaves are not deleted</span>
<a name='L1871'></a>            <span class="keyword">return</span>;
<a name='L1872'></a>        } <span class="keyword">else</span> <span class="keyword">if</span> (startnode == document.getElementById(<span class="string">"sn0"</span>)) {
<a name='L1873'></a>            <span class="keyword">return</span>;
<a name='L1874'></a>        }
<a name='L1875'></a>
<a name='L1876'></a>        <span class="keyword">var</span> toselect = $(startnode).children().first();
<a name='L1877'></a>        touchTree($(startnode));
<a name='L1878'></a>        $(startnode).replaceWith($(startnode).children());
<a name='L1879'></a>        startnode = endnode = <span class="keyword">null</span>;
<a name='L1880'></a>        selectNode(toselect.get(<span class="number">0</span>));
<a name='L1881'></a>        updateSelection();
<a name='L1882'></a>    }
<a name='L1883'></a>}
<a name='L1884'></a>
<a name='L1885'></a><span class="comment">// ========== Label manipulation</span>
<a name='L1886'></a>
<a name='L1887'></a><span class="comment">/**
<a name='L1888'></a> * Toggle a dash tag on a node
<a name='L1889'></a> *
<a name='L1890'></a> * If the node bears the given dash tag, remove it.  If not, add it.  This
<a name='L1891'></a> * function attempts to put multiple dash tags in the proper order, according
<a name='L1892'></a> * to the configuration in the `leaf_extensions`, `extensions`, and
<a name='L1893'></a> * `clause_extensions` variables in the `settings.js` file.
<a name='L1894'></a> *
<a name='L1895'></a> *<span class="phpdoc"> @param</span> {String} extension the dash tag to toggle
<a name='L1896'></a> *<span class="phpdoc"> @param</span> {Array of String} [extensionList] override the guess as to the
<a name='L1897'></a> * appropriate ordered list of possible extensions.
<a name='L1898'></a> */</span>
<a name='L1899'></a><span class="keyword">function</span> toggleExtension(extension, extensionList) {
<a name='L1900'></a>    <span class="keyword">if</span> (!startnode || endnode) <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L1901'></a>
<a name='L1902'></a>    <span class="keyword">if</span> (!extensionList) {
<a name='L1903'></a>        <span class="keyword">if</span> (guessLeafNode(startnode)) {
<a name='L1904'></a>            extensionList = leaf_extensions;
<a name='L1905'></a>        } <span class="keyword">else</span> <span class="keyword">if</span> (getLabel($(startnode)).split(<span class="string">"-"</span>)[<span class="number">0</span>] == <span class="string">"IP"</span> ||
<a name='L1906'></a>                   getLabel($(startnode)).split(<span class="string">"-"</span>)[<span class="number">0</span>] == <span class="string">"CP"</span>) {
<a name='L1907'></a>            <span class="comment">// TODO: should FRAG be a clause?</span>
<a name='L1908'></a>            <span class="comment">// TODO: make configurable</span>
<a name='L1909'></a>            extensionList = clause_extensions;
<a name='L1910'></a>        } <span class="keyword">else</span> {
<a name='L1911'></a>            extensionList = extensions;
<a name='L1912'></a>        }
<a name='L1913'></a>    }
<a name='L1914'></a>
<a name='L1915'></a>    <span class="comment">// Tried to toggle an extension on an inapplicable node.</span>
<a name='L1916'></a>    <span class="keyword">if</span> (extensionList.indexOf(extension) &lt; <span class="number">0</span>) {
<a name='L1917'></a>        <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L1918'></a>    }
<a name='L1919'></a>
<a name='L1920'></a>    touchTree($(startnode));
<a name='L1921'></a>    <span class="keyword">var</span> textnode = textNode($(startnode));
<a name='L1922'></a>    <span class="keyword">var</span> oldlabel = $.trim(textnode.text());
<a name='L1923'></a>    <span class="comment">// Extension is not de-dashed here.  toggleStringExtension handles it.</span>
<a name='L1924'></a>    <span class="comment">// The new config format however requires a dash-less extension.</span>
<a name='L1925'></a>    <span class="keyword">var</span> newlabel = toggleStringExtension(oldlabel, extension, extensionList);
<a name='L1926'></a>    textnode.replaceWith(newlabel + <span class="string">" "</span>);
<a name='L1927'></a>    updateCssClass($(startnode), oldlabel);
<a name='L1928'></a>
<a name='L1929'></a>    <span class="keyword">return</span> <span class="keyword">true</span>;
<a name='L1930'></a>}
<a name='L1931'></a>
<a name='L1932'></a><span class="comment">/**
<a name='L1933'></a> * Set the label of a node intelligently
<a name='L1934'></a> *
<a name='L1935'></a> * Given a list of labels, this function will attempt to find the node's
<a name='L1936'></a> * current label in the list.  If it is successful, it sets the node's label
<a name='L1937'></a> * to the next label in the list (or the first, if the node's current label is
<a name='L1938'></a> * the last in the list).  If not, it sets the label to the first label in the
<a name='L1939'></a> * list.
<a name='L1940'></a> *
<a name='L1941'></a> *<span class="phpdoc"> @param</span> labels a list of labels.  This can also be an object -- if so, the
<a name='L1942'></a> * base label (without any dash tags) of the target node is looked up as a
<a name='L1943'></a> * key, and its corresponding value is used as the list.  If there is no value
<a name='L1944'></a> * for that key, the first value specified in the object is the default.
<a name='L1945'></a> */</span>
<a name='L1946'></a><span class="keyword">function</span> setLabel(labels) {
<a name='L1947'></a>    <span class="keyword">if</span> (!startnode || endnode) {
<a name='L1948'></a>        <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L1949'></a>    }
<a name='L1950'></a>
<a name='L1951'></a>    <span class="keyword">var</span> textnode = textNode($(startnode));
<a name='L1952'></a>    <span class="keyword">var</span> oldlabel = $.trim(textnode.text());
<a name='L1953'></a>    <span class="keyword">var</span> newlabel = lookupNextLabel(oldlabel, labels);
<a name='L1954'></a>
<a name='L1955'></a>    <span class="keyword">if</span> (guessLeafNode($(startnode))) {
<a name='L1956'></a>        <span class="keyword">if</span> (typeof testValidLeafLabel !== <span class="string">"undefined"</span>) {
<a name='L1957'></a>            <span class="keyword">if</span> (!testValidLeafLabel(newlabel)) {
<a name='L1958'></a>                <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L1959'></a>            }
<a name='L1960'></a>        }
<a name='L1961'></a>    } <span class="keyword">else</span> {
<a name='L1962'></a>        <span class="keyword">if</span> (typeof testValidPhraseLabel !== <span class="string">"undefined"</span>) {
<a name='L1963'></a>            <span class="keyword">if</span> (!testValidPhraseLabel(newlabel)) {
<a name='L1964'></a>                <span class="keyword">return</span> <span class="keyword">false</span>;
<a name='L1965'></a>            }
<a name='L1966'></a>        }
<a name='L1967'></a>    }
<a name='L1968'></a>
<a name='L1969'></a>    touchTree($(startnode));
<a name='L1970'></a>
<a name='L1971'></a>    textnode.replaceWith(newlabel + <span class="string">" "</span>);
<a name='L1972'></a>    updateCssClass($(startnode), oldlabel);
<a name='L1973'></a>
<a name='L1974'></a>    <span class="keyword">return</span> <span class="keyword">true</span>;
<a name='L1975'></a>}
<a name='L1976'></a>
<a name='L1977'></a><span class="comment">// ========== Coindexation</span>
<a name='L1978'></a>
<a name='L1979'></a><span class="comment">/**
<a name='L1980'></a> * Coindex nodes.
<a name='L1981'></a> *
<a name='L1982'></a> * Coindex the two selected nodes.  If they are already coindexed, toggle
<a name='L1983'></a> * types of coindexation (normal -> gapping -> backwards gapping -> double
<a name='L1984'></a> * gapping -> no indices).  If only one node is selected, remove its index.
<a name='L1985'></a> */</span>
<a name='L1986'></a><span class="keyword">function</span> coIndex() {
<a name='L1987'></a>    <span class="keyword">if</span> (startnode &amp;&amp; !endnode) {
<a name='L1988'></a>        <span class="keyword">if</span> (getIndex($(startnode)) > <span class="number">0</span>) {
<a name='L1989'></a>            touchTree($(startnode));
<a name='L1990'></a>            removeIndex(startnode);
<a name='L1991'></a>        }
<a name='L1992'></a>    } <span class="keyword">else</span> <span class="keyword">if</span> (startnode &amp;&amp; endnode) {
<a name='L1993'></a>        <span class="comment">// don't do anything if different token roots</span>
<a name='L1994'></a>        <span class="keyword">var</span> startRoot = getTokenRoot($(startnode));
<a name='L1995'></a>        <span class="keyword">var</span> endRoot = getTokenRoot($(endnode));
<a name='L1996'></a>        <span class="keyword">if</span> (startRoot != endRoot) {
<a name='L1997'></a>            <span class="keyword">return</span>;
<a name='L1998'></a>        }
<a name='L1999'></a>
<a name='L2000'></a>        touchTree($(startnode));
<a name='L2001'></a>        <span class="comment">// if both nodes already have an index</span>
<a name='L2002'></a>        <span class="keyword">if</span> (getIndex($(startnode)) > <span class="number">0</span> &amp;&amp; getIndex($(endnode)) > <span class="number">0</span>) {
<a name='L2003'></a>            <span class="comment">// and if it is the same index</span>
<a name='L2004'></a>            <span class="keyword">if</span> (getIndex($(startnode)) == getIndex($(endnode))) {
<a name='L2005'></a>                <span class="keyword">var</span> theIndex = getIndex($(startnode));
<a name='L2006'></a>                <span class="keyword">var</span> types = <span class="string">""</span> + getIndexType($(startnode)) +
<a name='L2007'></a>                    <span class="string">""</span> + getIndexType($(endnode));
<a name='L2008'></a>                <span class="comment">// remove it</span>
<a name='L2009'></a>
<a name='L2010'></a>                <span class="keyword">if</span> (types == <span class="string">"=-"</span>) {
<a name='L2011'></a>                    removeIndex(startnode);
<a name='L2012'></a>                    removeIndex(endnode);
<a name='L2013'></a>                    appendExtension($(startnode), theIndex, <span class="string">"="</span>);
<a name='L2014'></a>                    appendExtension($(endnode), theIndex, <span class="string">"="</span>);
<a name='L2015'></a>                } <span class="keyword">else</span> <span class="keyword">if</span>( types == <span class="string">"--"</span> ){
<a name='L2016'></a>                    removeIndex(endnode);
<a name='L2017'></a>                    appendExtension($(endnode), getIndex($(startnode)),<span class="string">"="</span>);
<a name='L2018'></a>                } <span class="keyword">else</span> <span class="keyword">if</span> (types == <span class="string">"-="</span>) {
<a name='L2019'></a>                    removeIndex(startnode);
<a name='L2020'></a>                    removeIndex(endnode);
<a name='L2021'></a>                    appendExtension($(startnode), theIndex,<span class="string">"="</span>);
<a name='L2022'></a>                    appendExtension($(endnode), theIndex,<span class="string">"-"</span>);
<a name='L2023'></a>                } <span class="keyword">else</span> <span class="keyword">if</span> (types == <span class="string">"=="</span>) {
<a name='L2024'></a>                    removeIndex(startnode);
<a name='L2025'></a>                    removeIndex(endnode);
<a name='L2026'></a>                }
<a name='L2027'></a>            }
<a name='L2028'></a>        } <span class="keyword">else</span> <span class="keyword">if</span> (getIndex($(startnode)) > <span class="number">0</span> &amp;&amp; getIndex($(endnode)) == -<span class="number">1</span>) {
<a name='L2029'></a>            appendExtension($(endnode), getIndex($(startnode)));
<a name='L2030'></a>        } <span class="keyword">else</span> <span class="keyword">if</span> (getIndex($(startnode)) == -<span class="number">1</span> &amp;&amp; getIndex($(endnode)) > <span class="number">0</span>) {
<a name='L2031'></a>            appendExtension($(startnode), getIndex($(endnode)));
<a name='L2032'></a>        } <span class="keyword">else</span> { <span class="comment">// no indices here, so make them</span>
<a name='L2033'></a>            <span class="keyword">var</span> index = maxIndex(startRoot) + <span class="number">1</span>;
<a name='L2034'></a>            appendExtension($(startnode), index);
<a name='L2035'></a>            appendExtension($(endnode), index);
<a name='L2036'></a>        }
<a name='L2037'></a>    }
<a name='L2038'></a>}
<a name='L2039'></a>
<a name='L2040'></a><span class="comment">// ===== Server-side operations</span>
<a name='L2041'></a>
<a name='L2042'></a><span class="comment">// ========== Saving</span>
<a name='L2043'></a>
<a name='L2044'></a><span class="comment">// =============== Save helper function</span>
<a name='L2045'></a>
<a name='L2046'></a><span class="comment">// TODO: move to utils?</span>
<a name='L2047'></a><span class="comment">// TODO: this is not very general, in fact only works when called with</span>
<a name='L2048'></a><span class="comment">// #editpane as arg</span>
<a name='L2049'></a><span class="keyword">function</span> toLabeledBrackets(node) {
<a name='L2050'></a>    <span class="keyword">var</span> out = node.<span class="keyword">clone</span>();
<a name='L2051'></a>
<a name='L2052'></a>    <span class="comment">// The ZZZZZ is a placeholder; first we want to clean any</span>
<a name='L2053'></a>    <span class="comment">// double-linebreaks from the output (which will be spurious), then we</span>
<a name='L2054'></a>    <span class="comment">// will turn the Z's into double-linebreaks</span>
<a name='L2055'></a>    out.find(<span class="string">".snode:not(#sn0)"</span>).each(<span class="keyword">function</span> () {
<a name='L2056'></a>        <span class="keyword">this</span>.insertBefore(document.createTextNode(<span class="string">"("</span>), <span class="keyword">this</span>.firstChild);
<a name='L2057'></a>        <span class="keyword">this</span>.appendChild(document.createTextNode(<span class="string">")"</span>));
<a name='L2058'></a>    });
<a name='L2059'></a>
<a name='L2060'></a>    out.find(<span class="string">"#sn0>.snode"</span>).each(<span class="keyword">function</span> () {
<a name='L2061'></a>        $(<span class="keyword">this</span>).append(jsonToTree(<span class="keyword">this</span>.getAttribute(<span class="string">"data-metadata"</span>)));
<a name='L2062'></a>        <span class="keyword">this</span>.insertBefore(document.createTextNode(<span class="string">"( "</span>), <span class="keyword">this</span>.firstChild);
<a name='L2063'></a>        <span class="keyword">this</span>.appendChild(document.createTextNode(<span class="string">")ZZZZZ"</span>));
<a name='L2064'></a>    });
<a name='L2065'></a>
<a name='L2066'></a>    out.find(<span class="string">".wnode"</span>).each(<span class="keyword">function</span> () {
<a name='L2067'></a>        <span class="keyword">this</span>.insertBefore(document.createTextNode(<span class="string">" "</span>), <span class="keyword">this</span>.firstChild);
<a name='L2068'></a>    });
<a name='L2069'></a>
<a name='L2070'></a>    out = out.text();
<a name='L2071'></a>    <span class="comment">// Must use rx for string replace bc using a string doesn't get a</span>
<a name='L2072'></a>    <span class="comment">// global replace.</span>
<a name='L2073'></a>    out = out.replace(/\)\(/g, <span class="string">") ("</span>);
<a name='L2074'></a>    out = out.replace(/  +/g, <span class="string">" "</span>);
<a name='L2075'></a>    out = out.replace(/\n\n+/g,<span class="string">"\n"</span>);
<a name='L2076'></a>    out = out.replace(/ZZZZZ/g, <span class="string">"\n\n"</span>);
<a name='L2077'></a>    <span class="comment">// If there is a space after the word but before the closing paren, it</span>
<a name='L2078'></a>    <span class="comment">// will make CorpusSearch unhappy.</span>
<a name='L2079'></a>    out = out.replace(/ +\)/g, <span class="string">")"</span>);
<a name='L2080'></a>    <span class="comment">// Ditto for spaces btw. word and lemma, in dash format</span>
<a name='L2081'></a>    out = out.replace(/- +/g, <span class="string">"-"</span>);
<a name='L2082'></a>
<a name='L2083'></a>
<a name='L2084'></a>    <span class="keyword">return</span> out;
<a name='L2085'></a>}
<a name='L2086'></a>
<a name='L2087'></a><span class="keyword">var</span> saveInProgress = <span class="keyword">false</span>;
<a name='L2088'></a>
<a name='L2089'></a><span class="keyword">function</span> saveHandler (data) {
<a name='L2090'></a>    <span class="keyword">if</span> (data[<span class="string">'result'</span>] == <span class="string">"success"</span>) {
<a name='L2091'></a>        displayInfo(<span class="string">"Save success."</span>);
<a name='L2092'></a>    } <span class="keyword">else</span> {
<a name='L2093'></a>        lastsavedstate = <span class="string">""</span>;
<a name='L2094'></a>        <span class="keyword">var</span> extraInfo = <span class="string">""</span>;
<a name='L2095'></a>        <span class="comment">// TODO: let force saving sync the annotald instances, so it's only necessary once?</span>
<a name='L2096'></a>        <span class="keyword">if</span> (safeGet(data, <span class="string">'reasonCode'</span>, <span class="number">0</span>) == <span class="number">1</span>) {
<a name='L2097'></a>            extraInfo = <span class="string">" &lt;a href='#' id='forceSave' "</span> +
<a name='L2098'></a>                <span class="string">"onclick='javascript:save(null, true)'>Force save&lt;/a>"</span>;
<a name='L2099'></a>        }
<a name='L2100'></a>        displayError(<span class="string">"Save FAILED!!!: "</span> + data[<span class="string">'reason'</span>] + extraInfo);
<a name='L2101'></a>    }
<a name='L2102'></a>    saveInProgress = <span class="keyword">false</span>;
<a name='L2103'></a>}
<a name='L2104'></a>
<a name='L2105'></a><span class="keyword">function</span> save(e, force) {
<a name='L2106'></a>    <span class="keyword">if</span> (!saveInProgress) {
<a name='L2107'></a>        <span class="keyword">if</span> (force) {
<a name='L2108'></a>            force = <span class="keyword">true</span>;
<a name='L2109'></a>        } <span class="keyword">else</span> {
<a name='L2110'></a>            force = <span class="keyword">false</span>;
<a name='L2111'></a>        }
<a name='L2112'></a>        displayInfo(<span class="string">"Saving..."</span>);
<a name='L2113'></a>        saveInProgress = <span class="keyword">true</span>;
<a name='L2114'></a>        setTimeout(<span class="keyword">function</span> () {
<a name='L2115'></a>            <span class="keyword">var</span> tosave = toLabeledBrackets($(<span class="string">"#editpane"</span>));
<a name='L2116'></a>            $.post(<span class="string">"/doSave"</span>, { trees: tosave,
<a name='L2117'></a>                                startTime: startTime,
<a name='L2118'></a>                                force: force
<a name='L2119'></a>                              }, saveHandler).error(<span class="keyword">function</span> () {
<a name='L2120'></a>                                  lastsavedstate = <span class="string">""</span>;
<a name='L2121'></a>                                  saveInProgress = <span class="keyword">false</span>;
<a name='L2122'></a>                              });
<a name='L2123'></a>            <span class="keyword">if</span> ($(<span class="string">"#idlestatus"</span>).html().search(<span class="string">"IDLE"</span>) != -<span class="number">1</span>) {
<a name='L2124'></a>                idle();
<a name='L2125'></a>            }
<a name='L2126'></a>            lastsavedstate = $(<span class="string">"#editpane"</span>).html();
<a name='L2127'></a>        }, <span class="number">0</span>);
<a name='L2128'></a>    }
<a name='L2129'></a>}
<a name='L2130'></a>
<a name='L2131'></a><span class="comment">// ========== Validating</span>
<a name='L2132'></a>
<a name='L2133'></a><span class="keyword">var</span> validatingCurrently = <span class="keyword">false</span>;
<a name='L2134'></a>
<a name='L2135'></a><span class="keyword">function</span> validateTrees(e) {
<a name='L2136'></a>    <span class="keyword">if</span> (!validatingCurrently) {
<a name='L2137'></a>        validatingCurrently = <span class="keyword">true</span>;
<a name='L2138'></a>        displayInfo(<span class="string">"Validating..."</span>);
<a name='L2139'></a>        setTimeout(<span class="keyword">function</span> () {
<a name='L2140'></a>            <span class="comment">// TODO: since this is a settimeout, do we need to also make it async?</span>
<a name='L2141'></a>            validateTreesSync(<span class="keyword">true</span>, e.shiftKey);
<a name='L2142'></a>        }, <span class="number">0</span>);
<a name='L2143'></a>    }
<a name='L2144'></a>}
<a name='L2145'></a>
<a name='L2146'></a><span class="keyword">function</span> validateTreesSync(async, shift) {
<a name='L2147'></a>    <span class="keyword">var</span> toValidate = toLabeledBrackets($(<span class="string">"#editpane"</span>));
<a name='L2148'></a>    $.ajax(<span class="string">"/doValidate"</span>,
<a name='L2149'></a>           { type: <span class="string">'POST'</span>,
<a name='L2150'></a>             url: <span class="string">"/doValidate"</span>,
<a name='L2151'></a>             data: { trees: toValidate,
<a name='L2152'></a>                     validator: $(<span class="string">"#validatorsSelect"</span>).val(),
<a name='L2153'></a>                     shift: shift
<a name='L2154'></a>                   },
<a name='L2155'></a>             success: validateHandler,
<a name='L2156'></a>             async: async,
<a name='L2157'></a>             dataType: <span class="string">"json"</span>
<a name='L2158'></a>           });
<a name='L2159'></a>}
<a name='L2160'></a>
<a name='L2161'></a><span class="keyword">function</span> validateHandler(data) {
<a name='L2162'></a>    <span class="keyword">if</span> (data[<span class="string">'result'</span>] == <span class="string">"success"</span>) {
<a name='L2163'></a>        displayInfo(<span class="string">"Validate success."</span>);
<a name='L2164'></a>        $(<span class="string">"#editpane"</span>).html(data[<span class="string">'html'</span>]);
<a name='L2165'></a>        documentReadyHandler();
<a name='L2166'></a>    } <span class="keyword">else</span> <span class="keyword">if</span> (data[<span class="string">'result'</span>] == <span class="string">"failure"</span>) {
<a name='L2167'></a>        displayWarning(<span class="string">"Validate failed: "</span> + data[<span class="string">'reason'</span>]);
<a name='L2168'></a>    }
<a name='L2169'></a>    validatingCurrently = <span class="keyword">false</span>;
<a name='L2170'></a>    <span class="comment">// TODO(AWE): more nuanced distinction between validation found errors and</span>
<a name='L2171'></a>    <span class="comment">// validation script itself contains errors</span>
<a name='L2172'></a>}
<a name='L2173'></a>
<a name='L2174'></a><span class="keyword">function</span> nextValidationError() {
<a name='L2175'></a>    scrollToNext(<span class="string">".snode[class*=\"FLAG\"],.snode[class$=\"FLAG\"]"</span>);
<a name='L2176'></a>}
<a name='L2177'></a>
<a name='L2178'></a><span class="comment">// ========== Advancing through the file</span>
<a name='L2179'></a>
<a name='L2180'></a><span class="keyword">function</span> nextTree(e) {
<a name='L2181'></a>    <span class="keyword">var</span> find = undefined;
<a name='L2182'></a>    <span class="keyword">if</span> (e.shiftKey) find = <span class="string">"-FLAG"</span>;
<a name='L2183'></a>    advanceTree(find, <span class="keyword">false</span>, <span class="number">1</span>);
<a name='L2184'></a>}
<a name='L2185'></a>
<a name='L2186'></a><span class="keyword">function</span> prevTree(e) {
<a name='L2187'></a>    <span class="keyword">var</span> find = undefined;
<a name='L2188'></a>    <span class="keyword">if</span> (e.shiftKey) find = <span class="string">"-FLAG"</span>;
<a name='L2189'></a>    advanceTree(find, <span class="keyword">false</span>, -<span class="number">1</span>);
<a name='L2190'></a>}
<a name='L2191'></a>
<a name='L2192'></a><span class="keyword">function</span> advanceTree(find, async, offset) {
<a name='L2193'></a>    <span class="keyword">var</span> theTrees = toLabeledBrackets($(<span class="string">"#editpane"</span>));
<a name='L2194'></a>    displayInfo(<span class="string">"Fetching tree..."</span>);
<a name='L2195'></a>    <span class="keyword">return</span> $.ajax(<span class="string">"/advanceTree"</span>,
<a name='L2196'></a>                  { async: async,
<a name='L2197'></a>                    success: <span class="keyword">function</span>(res) {
<a name='L2198'></a>                        <span class="keyword">if</span> (res[<span class="string">'result'</span>] == <span class="string">"failure"</span>) {
<a name='L2199'></a>                            displayWarning(<span class="string">"Fetching tree failed: "</span> + res[<span class="string">'reason'</span>]);
<a name='L2200'></a>                        } <span class="keyword">else</span> {
<a name='L2201'></a>                            <span class="comment">// TODO: what to do about the save warning</span>
<a name='L2202'></a>                            $(<span class="string">"#editpane"</span>).html(res[<span class="string">'tree'</span>]);
<a name='L2203'></a>                            documentReadyHandler();
<a name='L2204'></a>                            nukeUndo();
<a name='L2205'></a>                            displayInfo(<span class="string">"Tree fetched."</span>);
<a name='L2206'></a>                        }
<a name='L2207'></a>                    },
<a name='L2208'></a>                    dataType: <span class="string">"json"</span>,
<a name='L2209'></a>                    type: <span class="string">"POST"</span>,
<a name='L2210'></a>                    data: { trees: theTrees,
<a name='L2211'></a>                            find: find,
<a name='L2212'></a>                            offset: offset
<a name='L2213'></a>                          }});
<a name='L2214'></a>}
<a name='L2215'></a>
<a name='L2216'></a><span class="comment">// ========== Idle/resume</span>
<a name='L2217'></a>
<a name='L2218'></a><span class="keyword">function</span> idle() {
<a name='L2219'></a>    <span class="keyword">if</span> ($(<span class="string">"#idlestatus"</span>).html().search(<span class="string">"IDLE"</span>) != -<span class="number">1</span>) {
<a name='L2220'></a>        $.post(<span class="string">"/doIdle"</span>);
<a name='L2221'></a>        $(<span class="string">"#idlestatus"</span>).html(<span class="string">"&lt;div style='color:green'>Status: Editing.&lt;/div>"</span>);
<a name='L2222'></a>    }
<a name='L2223'></a>    <span class="keyword">else</span> {
<a name='L2224'></a>        $.post(<span class="string">"/doIdle"</span>);
<a name='L2225'></a>        $(<span class="string">"#idlestatus"</span>).html(<span class="string">""</span>);
<a name='L2226'></a>        $(<span class="string">"#idlestatus"</span>).html(<span class="string">"&lt;div style='color:red'>Status: IDLE.&lt;/div>"</span>);
<a name='L2227'></a>    }
<a name='L2228'></a>}
<a name='L2229'></a>
<a name='L2230'></a><span class="comment">// ========== Quitting</span>
<a name='L2231'></a>
<a name='L2232'></a><span class="keyword">function</span> quitServer() {
<a name='L2233'></a>    <span class="keyword">if</span> ($(<span class="string">"#editpane"</span>).html() != lastsavedstate) {
<a name='L2234'></a>        alert(<span class="string">"Cannot exit, unsaved changes exist."</span>);
<a name='L2235'></a>    } <span class="keyword">else</span> {
<a name='L2236'></a>        $.post(<span class="string">"/doExit"</span>);
<a name='L2237'></a>        window.onbeforeunload = undefined;
<a name='L2238'></a>        setTimeout(<span class="keyword">function</span>(res) {
<a name='L2239'></a>                       <span class="comment">// I have no idea why this works, but it does</span>
<a name='L2240'></a>                       window.open(<span class="string">''</span>, <span class="string">'_self'</span>, <span class="string">''</span>);
<a name='L2241'></a>                       window.close();
<a name='L2242'></a>               }, <span class="number">100</span>);
<a name='L2243'></a>    }
<a name='L2244'></a>}
<a name='L2245'></a>
<a name='L2246'></a><span class="comment">// ===== Undo/redo</span>
<a name='L2247'></a>
<a name='L2248'></a><span class="comment">// TODO: organize this code</span>
<a name='L2249'></a>
<a name='L2250'></a><span class="keyword">var</span> undoMap,
<a name='L2251'></a>    undoNewTrees,
<a name='L2252'></a>    undoDeletedTrees,
<a name='L2253'></a>    undoStack = [],
<a name='L2254'></a>    redoStack = [],
<a name='L2255'></a>    undoTransactionStack = [];
<a name='L2256'></a>
<a name='L2257'></a><span class="keyword">var</span> idNumber = <span class="number">1</span>;
<a name='L2258'></a>
<a name='L2259'></a>addStartupHook(<span class="keyword">function</span> () {
<a name='L2260'></a>    $(<span class="string">"#sn0>.snode"</span>).map(<span class="keyword">function</span> () {
<a name='L2261'></a>        $(<span class="keyword">this</span>).attr(<span class="string">"id"</span>, <span class="string">"id"</span> + idNumber);
<a name='L2262'></a>        idNumber++;
<a name='L2263'></a>    });
<a name='L2264'></a>    resetUndo();
<a name='L2265'></a>});
<a name='L2266'></a>
<a name='L2267'></a><span class="comment">/**
<a name='L2268'></a> * Reset the undo system.
<a name='L2269'></a> *
<a name='L2270'></a> * This function removes any intermediate state the undo system has stored; it
<a name='L2271'></a> * does not affect the undo history.
<a name='L2272'></a> *<span class="phpdoc"> @private</span>
<a name='L2273'></a> *<span class="phpdoc"> @memberOf</span> Undo
<a name='L2274'></a> */</span>
<a name='L2275'></a><span class="keyword">function</span> resetUndo() {
<a name='L2276'></a>    undoMap = {};
<a name='L2277'></a>    undoNewTrees = [];
<a name='L2278'></a>    undoDeletedTrees = [];
<a name='L2279'></a>    undoTransactionStack = [];
<a name='L2280'></a>}
<a name='L2281'></a>
<a name='L2282'></a><span class="comment">/**
<a name='L2283'></a> * Reset the undo system entirely.
<a name='L2284'></a> *
<a name='L2285'></a> * This function zeroes out any undo history.
<a name='L2286'></a> */</span>
<a name='L2287'></a><span class="keyword">function</span> nukeUndo() {
<a name='L2288'></a>    resetUndo();
<a name='L2289'></a>    undoStack = [];
<a name='L2290'></a>    redoStack = [];
<a name='L2291'></a>}
<a name='L2292'></a>
<a name='L2293'></a><span class="comment">/**
<a name='L2294'></a> * Record an undo step.
<a name='L2295'></a> *<span class="phpdoc"> @private</span>
<a name='L2296'></a> */</span>
<a name='L2297'></a><span class="keyword">function</span> undoBarrier() {
<a name='L2298'></a>    <span class="keyword">if</span> (_.size(undoMap) == <span class="number">0</span> &amp;&amp;
<a name='L2299'></a>        _.size(undoNewTrees) == <span class="number">0</span> &amp;&amp;
<a name='L2300'></a>        _.size(undoDeletedTrees) == <span class="number">0</span>) {
<a name='L2301'></a>        <span class="keyword">return</span>;
<a name='L2302'></a>    }
<a name='L2303'></a>    undoStack.push({
<a name='L2304'></a>        map: undoMap,
<a name='L2305'></a>        newTr: undoNewTrees,
<a name='L2306'></a>        delTr: undoDeletedTrees
<a name='L2307'></a>    });
<a name='L2308'></a>    resetUndo();
<a name='L2309'></a>    redoStack = [];
<a name='L2310'></a>}
<a name='L2311'></a>
<a name='L2312'></a><span class="comment">/**
<a name='L2313'></a> * Begin an undo transaction.
<a name='L2314'></a> *
<a name='L2315'></a> * This function MUST be matched by a call to either `undoEndTransaction`
<a name='L2316'></a> * (which keeps all intermediate steps since the start call) or
<a name='L2317'></a> * `undoAbortTransaction` (which discards said steps).
<a name='L2318'></a> */</span>
<a name='L2319'></a><span class="keyword">function</span> undoBeginTransaction() {
<a name='L2320'></a>    undoTransactionStack.push({
<a name='L2321'></a>        map: undoMap,
<a name='L2322'></a>        newTr: undoNewTrees,
<a name='L2323'></a>        delTr: undoDeletedTrees
<a name='L2324'></a>    });
<a name='L2325'></a>}
<a name='L2326'></a>
<a name='L2327'></a><span class="comment">/**
<a name='L2328'></a> * End an undo transaction, keeping its changes
<a name='L2329'></a> */</span>
<a name='L2330'></a><span class="keyword">function</span> undoEndTransaction() {
<a name='L2331'></a>    undoTransactionStack.pop();
<a name='L2332'></a>}
<a name='L2333'></a>
<a name='L2334'></a><span class="comment">/**
<a name='L2335'></a> * End an undo transaction, discarding its changes
<a name='L2336'></a> */</span>
<a name='L2337'></a><span class="keyword">function</span> undoAbortTransaction() {
<a name='L2338'></a>    <span class="keyword">var</span> t = undoTransactionStack.pop();
<a name='L2339'></a>    undoMap = t[<span class="string">"map"</span>];
<a name='L2340'></a>    undoNewTrees = t[<span class="string">"newTr"</span>];
<a name='L2341'></a>    undoDeletedTrees = t[<span class="string">"delTr"</span>];
<a name='L2342'></a>}
<a name='L2343'></a>
<a name='L2344'></a><span class="comment">/**
<a name='L2345'></a> * Execute a function, discarding whatever effects it has on the undo system.
<a name='L2346'></a> *
<a name='L2347'></a> *<span class="phpdoc"> @param</span> {Function} fn a function to execute
<a name='L2348'></a> *
<a name='L2349'></a> *<span class="phpdoc"> @returns</span> the result of `fn`
<a name='L2350'></a> */</span>
<a name='L2351'></a><span class="keyword">function</span> ignoringUndo(fn) {
<a name='L2352'></a>    <span class="comment">// a bit of a grim hack, but it works</span>
<a name='L2353'></a>    undoBeginTransaction();
<a name='L2354'></a>    <span class="keyword">var</span> res = fn();
<a name='L2355'></a>    undoAbortTransaction();
<a name='L2356'></a>    <span class="keyword">return</span> res;
<a name='L2357'></a>}
<a name='L2358'></a>
<a name='L2359'></a><span class="comment">/**
<a name='L2360'></a> * Inform the undo system that changes are being made.
<a name='L2361'></a> *
<a name='L2362'></a> *<span class="phpdoc"> @param</span> {JQuery Node} node the node in which changes are being made
<a name='L2363'></a> */</span>
<a name='L2364'></a><span class="keyword">function</span> touchTree(node) {
<a name='L2365'></a>    <span class="keyword">var</span> root = $(getTokenRoot(node));
<a name='L2366'></a>    <span class="keyword">if</span> (!undoMap[root.attr(<span class="string">"id"</span>)]) {
<a name='L2367'></a>        undoMap[root.attr(<span class="string">"id"</span>)] = root.<span class="keyword">clone</span>();
<a name='L2368'></a>    }
<a name='L2369'></a>}
<a name='L2370'></a>
<a name='L2371'></a><span class="comment">/**
<a name='L2372'></a> * Inform the undo system of the addition of a new tree at the root level.
<a name='L2373'></a> *
<a name='L2374'></a> *<span class="phpdoc"> @param</span> {JQuery Node} tree the tree being added
<a name='L2375'></a> */</span>
<a name='L2376'></a><span class="keyword">function</span> registerNewRootTree(tree) {
<a name='L2377'></a>    <span class="keyword">var</span> newid = <span class="string">"id"</span> + idNumber;
<a name='L2378'></a>    idNumber++;
<a name='L2379'></a>    undoNewTrees.push(newid);
<a name='L2380'></a>    tree.attr(<span class="string">"id"</span>, newid);
<a name='L2381'></a>}
<a name='L2382'></a>
<a name='L2383'></a><span class="comment">/**
<a name='L2384'></a> * Inform the undo system of a tree's removal at the root level
<a name='L2385'></a> *
<a name='L2386'></a> *<span class="phpdoc"> @param</span> {JQuery Node} tree the tree being removed
<a name='L2387'></a> */</span>
<a name='L2388'></a><span class="keyword">function</span> registerDeletedRootTree(tree) {
<a name='L2389'></a>    <span class="keyword">var</span> prev = tree.prev();
<a name='L2390'></a>    <span class="keyword">if</span> (prev.length == <span class="number">0</span>) {
<a name='L2391'></a>        prev = <span class="keyword">null</span>;
<a name='L2392'></a>    }
<a name='L2393'></a>    undoDeletedTrees.push({
<a name='L2394'></a>        tree: tree,
<a name='L2395'></a>        before: prev &amp;&amp; prev.attr(<span class="string">"id"</span>)
<a name='L2396'></a>    });
<a name='L2397'></a>}
<a name='L2398'></a>
<a name='L2399'></a><span class="comment">/**
<a name='L2400'></a> * Perform an undo operation.
<a name='L2401'></a> *
<a name='L2402'></a> * This is a worker function, wrapped by `undo` and `redo`.
<a name='L2403'></a> *<span class="phpdoc"> @private</span>
<a name='L2404'></a> */</span>
<a name='L2405'></a><span class="keyword">function</span> doUndo(undoData) {
<a name='L2406'></a>    <span class="keyword">var</span> map = {},
<a name='L2407'></a>        newTr = [],
<a name='L2408'></a>        delTr = [];
<a name='L2409'></a>
<a name='L2410'></a>    _.each(undoData[<span class="string">"map"</span>], <span class="keyword">function</span>(v, k) {
<a name='L2411'></a>        <span class="keyword">var</span> theNode = $(<span class="string">"#"</span> + k);
<a name='L2412'></a>        map[k] = theNode.<span class="keyword">clone</span>();
<a name='L2413'></a>        theNode.replaceWith(v);
<a name='L2414'></a>    });
<a name='L2415'></a>
<a name='L2416'></a>    <span class="comment">// Add back the deleted trees before removing the new trees, just in case</span>
<a name='L2417'></a>    <span class="comment">// the insertion point of one of these is going to get zapped.  This</span>
<a name='L2418'></a>    <span class="comment">// shouldn't happen, though.</span>
<a name='L2419'></a>    _.each(undoData[<span class="string">"delTr"</span>], <span class="keyword">function</span>(v) {
<a name='L2420'></a>        <span class="keyword">var</span> prev = v[<span class="string">"before"</span>];
<a name='L2421'></a>        <span class="keyword">if</span> (prev) {
<a name='L2422'></a>            v[<span class="string">"tree"</span>].insertAfter($(<span class="string">"#"</span> + prev));
<a name='L2423'></a>        } <span class="keyword">else</span> {
<a name='L2424'></a>            v[<span class="string">"tree"</span>].prependTo($(<span class="string">"#sn0"</span>));
<a name='L2425'></a>        }
<a name='L2426'></a>        newTr.push(v[<span class="string">"tree"</span>].attr(<span class="string">"id"</span>));
<a name='L2427'></a>    });
<a name='L2428'></a>
<a name='L2429'></a>    _.each(undoData[<span class="string">"newTr"</span>], <span class="keyword">function</span>(v) {
<a name='L2430'></a>        <span class="keyword">var</span> theNode = $(<span class="string">"#"</span> + v);
<a name='L2431'></a>        <span class="keyword">var</span> prev = theNode.prev();
<a name='L2432'></a>        <span class="keyword">if</span> (prev.length == <span class="number">0</span>) {
<a name='L2433'></a>            prev = <span class="keyword">null</span>;
<a name='L2434'></a>        }
<a name='L2435'></a>        delTr.push({
<a name='L2436'></a>            tree: theNode.<span class="keyword">clone</span>(),
<a name='L2437'></a>            before: prev &amp;&amp; prev.attr(<span class="string">"id"</span>)
<a name='L2438'></a>        });
<a name='L2439'></a>        theNode.remove();
<a name='L2440'></a>    });
<a name='L2441'></a>
<a name='L2442'></a>    <span class="keyword">return</span> {
<a name='L2443'></a>        map: map,
<a name='L2444'></a>        newTr: newTr,
<a name='L2445'></a>        delTr: delTr
<a name='L2446'></a>    };
<a name='L2447'></a>}
<a name='L2448'></a>
<a name='L2449'></a><span class="comment">/**
<a name='L2450'></a> * Perform undo.
<a name='L2451'></a> */</span>
<a name='L2452'></a><span class="keyword">function</span> undo() {
<a name='L2453'></a>    <span class="keyword">if</span> (undoStack.length == <span class="number">0</span>) {
<a name='L2454'></a>        displayWarning(<span class="string">"No further undo information"</span>);
<a name='L2455'></a>        <span class="keyword">return</span>;
<a name='L2456'></a>    }
<a name='L2457'></a>    <span class="keyword">var</span> lastUndo = undoStack.pop();
<a name='L2458'></a>    redoStack.push(doUndo(lastUndo));
<a name='L2459'></a>    startnode = endnode = undefined;
<a name='L2460'></a>    updateSelection();
<a name='L2461'></a>}
<a name='L2462'></a>
<a name='L2463'></a><span class="comment">/**
<a name='L2464'></a> * Perform redo.
<a name='L2465'></a> */</span>
<a name='L2466'></a><span class="keyword">function</span> redo () {
<a name='L2467'></a>    <span class="keyword">if</span> (redoStack.length == <span class="number">0</span>) {
<a name='L2468'></a>        displayWarning(<span class="string">"No further redo information"</span>);
<a name='L2469'></a>        <span class="keyword">return</span>;
<a name='L2470'></a>    }
<a name='L2471'></a>    undoStack.push(doUndo(redoStack.pop()));
<a name='L2472'></a>    startnode = endnode = undefined;
<a name='L2473'></a>    updateSelection();
<a name='L2474'></a>}
<a name='L2475'></a>
<a name='L2476'></a><span class="comment">// ===== Misc</span>
<a name='L2477'></a>
<a name='L2478'></a><span class="comment">/**
<a name='L2479'></a> * Toggle display of lemmata.
<a name='L2480'></a> */</span>
<a name='L2481'></a><span class="keyword">function</span> toggleLemmata() {
<a name='L2482'></a>    <span class="keyword">if</span> (lemmataHidden) {
<a name='L2483'></a>        lemmataStyleNode.innerHTML = <span class="string">""</span>;
<a name='L2484'></a>    } <span class="keyword">else</span> {
<a name='L2485'></a>        lemmataStyleNode.innerHTML = <span class="string">".lemma { display: none; }"</span>;
<a name='L2486'></a>    }
<a name='L2487'></a>    lemmataHidden = !lemmataHidden;
<a name='L2488'></a>}
<a name='L2489'></a>
<a name='L2490'></a><span class="keyword">function</span> fixError() {
<a name='L2491'></a>    <span class="keyword">if</span> (!startnode || endnode) <span class="keyword">return</span>;
<a name='L2492'></a>    <span class="keyword">var</span> sn = $(startnode);
<a name='L2493'></a>    <span class="keyword">if</span> (hasDashTag(sn, <span class="string">"FLAG"</span>)) {
<a name='L2494'></a>        toggleExtension(<span class="string">"FLAG"</span>, [<span class="string">"FLAG"</span>]);
<a name='L2495'></a>    }
<a name='L2496'></a>    updateSelection();
<a name='L2497'></a>}
<a name='L2498'></a>
<a name='L2499'></a><span class="keyword">function</span> zeroDashTags() {
<a name='L2500'></a>    <span class="keyword">if</span> (!startnode || endnode) <span class="keyword">return</span>;
<a name='L2501'></a>    <span class="keyword">var</span> label = getLabel($(startnode));
<a name='L2502'></a>    <span class="keyword">var</span> idx = parseIndex(label),
<a name='L2503'></a>        idxType = parseIndexType(label),
<a name='L2504'></a>        lab = parseLabel(label);
<a name='L2505'></a>    <span class="keyword">if</span> (idx == -<span class="number">1</span>) {
<a name='L2506'></a>        idx = idxType = <span class="string">""</span>;
<a name='L2507'></a>    }
<a name='L2508'></a>    touchTree($(startnode));
<a name='L2509'></a>    setLabelLL($(startnode), lab.split(<span class="string">"-"</span>)[<span class="number">0</span>] + idxType + idx);
<a name='L2510'></a>}
<a name='L2511'></a>
<a name='L2512'></a><span class="comment">// TODO: should allow numeric indices; document</span>
<a name='L2513'></a><span class="keyword">function</span> basesAndDashes(bases, dashes) {
<a name='L2514'></a>    <span class="keyword">function</span> _basesAndDashes(string) {
<a name='L2515'></a>        <span class="keyword">var</span> spl = string.split(<span class="string">"-"</span>);
<a name='L2516'></a>        <span class="keyword">var</span> b = spl.shift();
<a name='L2517'></a>        <span class="keyword">return</span> (bases.indexOf(b) > -<span class="number">1</span>) &amp;&amp;
<a name='L2518'></a>            _.all(spl, <span class="keyword">function</span> (x) { <span class="keyword">return</span> (dashes.indexOf(x) > -<span class="number">1</span>); });
<a name='L2519'></a>    }
<a name='L2520'></a>    <span class="keyword">return</span> _basesAndDashes;
<a name='L2521'></a>}
<a name='L2522'></a>
<a name='L2523'></a><span class="keyword">function</span> addLemma(lemma) {
<a name='L2524'></a>    <span class="comment">// TODO: This only makes sense for dash-format corpora</span>
<a name='L2525'></a>    <span class="keyword">if</span> (!startnode || endnode) <span class="keyword">return</span>;
<a name='L2526'></a>    <span class="keyword">if</span> (!isLeafNode($(startnode)) || isEmpty(startnode)) <span class="keyword">return</span>;
<a name='L2527'></a>    touchTree($(startnode));
<a name='L2528'></a>    <span class="keyword">var</span> theLemma = $(<span class="string">"&lt;span class='lemma'>-"</span> + lemma +
<a name='L2529'></a>                     <span class="string">"&lt;/span>"</span>);
<a name='L2530'></a>    $(startnode).children(<span class="string">".wnode"</span>).append(theLemma);
<a name='L2531'></a>}
<a name='L2532'></a>
<a name='L2533'></a><span class="keyword">function</span> untilSuccess() {
<a name='L2534'></a>    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arguments.length; i++) {
<a name='L2535'></a>        <span class="keyword">var</span> fn = arguments[i][<span class="number">0</span>],
<a name='L2536'></a>            args = arguments[i].slice(<span class="number">1</span>);
<a name='L2537'></a>        <span class="keyword">var</span> res = fn.apply(<span class="keyword">null</span>, args);
<a name='L2538'></a>        <span class="keyword">if</span> (res) {
<a name='L2539'></a>            <span class="keyword">return</span>;
<a name='L2540'></a>        }
<a name='L2541'></a>    }
<a name='L2542'></a>}
<a name='L2543'></a>
<a name='L2544'></a><span class="comment">// ===== Misc (candidates to move to utils)</span>
<a name='L2545'></a>
<a name='L2546'></a><span class="comment">// TODO: move to utils?</span>
<a name='L2547'></a><span class="keyword">function</span> setLeafLabel(node, label) {
<a name='L2548'></a>    <span class="keyword">if</span> (!node.hasClass(<span class="string">".wnode"</span>)) {
<a name='L2549'></a>        <span class="comment">// why do we do this?  We should be less fault-tolerant.</span>
<a name='L2550'></a>        node = node.children(<span class="string">".wnode"</span>).first();
<a name='L2551'></a>    }
<a name='L2552'></a>    textNode(node).replaceWith($.trim(label));
<a name='L2553'></a>}
<a name='L2554'></a><span class="comment">// TODO: need a setLemma function as well</span>
<a name='L2555'></a>
<a name='L2556'></a><span class="comment">// TODO: only called from one place, with indices: possibly specialize name?</span>
<a name='L2557'></a><span class="keyword">function</span> appendExtension(node, extension, type) {
<a name='L2558'></a>    <span class="keyword">if</span> (!type) {
<a name='L2559'></a>        type=<span class="string">"-"</span>;
<a name='L2560'></a>    }
<a name='L2561'></a>    <span class="keyword">if</span> (shouldIndexLeaf(node) &amp;&amp; !isNaN(extension)) {
<a name='L2562'></a>        <span class="comment">// Adding an index to an empty category, and the EC is not an</span>
<a name='L2563'></a>        <span class="comment">// empty operator.  The final proviso is needed because of</span>
<a name='L2564'></a>        <span class="comment">// things like the empty WADJP in comparatives.</span>
<a name='L2565'></a>        <span class="keyword">var</span> oldLabel = textNode(node.children(<span class="string">".wnode"</span>).first()).text();;
<a name='L2566'></a>        setLeafLabel(node, oldLabel + type + extension);
<a name='L2567'></a>    } <span class="keyword">else</span> {
<a name='L2568'></a>        setNodeLabel(node, getLabel(node) + type + extension, <span class="keyword">true</span>);
<a name='L2569'></a>    }
<a name='L2570'></a>}
<a name='L2571'></a>
<a name='L2572'></a><span class="keyword">function</span> removeIndex(node) {
<a name='L2573'></a>    node = $(node);
<a name='L2574'></a>    <span class="keyword">if</span> (getIndex(node) == -<span class="number">1</span>) {
<a name='L2575'></a>        <span class="keyword">return</span>;
<a name='L2576'></a>    }
<a name='L2577'></a>    <span class="keyword">var</span> label, setLabelFn;
<a name='L2578'></a>    <span class="keyword">if</span> (shouldIndexLeaf(node)) {
<a name='L2579'></a>        label = wnodeString(node);
<a name='L2580'></a>        setLabelFn = setLeafLabel;
<a name='L2581'></a>    } <span class="keyword">else</span> {
<a name='L2582'></a>        label = getLabel(node);
<a name='L2583'></a>        setLabelFn = setNodeLabel;
<a name='L2584'></a>    }
<a name='L2585'></a>    setLabelFn(node,
<a name='L2586'></a>               label.substr(<span class="number">0</span>, Math.max(label.lastIndexOf(<span class="string">"-"</span>),
<a name='L2587'></a>                                        label.lastIndexOf(<span class="string">"="</span>))),
<a name='L2588'></a>               <span class="keyword">true</span>);
<a name='L2589'></a>}
<a name='L2590'></a>
<a name='L2591'></a><span class="comment">// A low-level (LL) version of setLabel.  It is only responsible for changing</span>
<a name='L2592'></a><span class="comment">// the label; not doing any kind of matching/changing/other crap.</span>
<a name='L2593'></a><span class="keyword">function</span> setLabelLL(node, label) {
<a name='L2594'></a>    <span class="keyword">if</span> (node.hasClass(<span class="string">"snode"</span>)) {
<a name='L2595'></a>        <span class="keyword">if</span> (label[label.length - <span class="number">1</span>] != <span class="string">" "</span>) {
<a name='L2596'></a>            <span class="comment">// Some other spots in the code depend on the label ending with a</span>
<a name='L2597'></a>            <span class="comment">// space...</span>
<a name='L2598'></a>            label += <span class="string">" "</span>;
<a name='L2599'></a>        }
<a name='L2600'></a>    } <span class="keyword">else</span> <span class="keyword">if</span> (node.hasClass(<span class="string">"wnode"</span>)) {
<a name='L2601'></a>        <span class="comment">// Words cannot have a trailing space, or CS barfs on save.</span>
<a name='L2602'></a>        label = $.trim(label);
<a name='L2603'></a>    } <span class="keyword">else</span> {
<a name='L2604'></a>        <span class="comment">// should never happen</span>
<a name='L2605'></a>        <span class="keyword">return</span>;
<a name='L2606'></a>    }
<a name='L2607'></a>    <span class="keyword">var</span> oldLabel = parseLabel(getLabel(node));
<a name='L2608'></a>    textNode(node).replaceWith(label);
<a name='L2609'></a>    updateCssClass(node, oldLabel);
<a name='L2610'></a>}
<a name='L2611'></a>
<a name='L2612'></a><span class="comment">/**
<a name='L2613'></a> * Update the CSS class of a node to reflect its label.
<a name='L2614'></a> *
<a name='L2615'></a> *<span class="phpdoc"> @param</span> {JQuery Node} node
<a name='L2616'></a> *<span class="phpdoc"> @param</span> {String} oldlabel (optional) the former label of this node
<a name='L2617'></a> */</span>
<a name='L2618'></a><span class="keyword">function</span> updateCssClass(node, oldlabel) {
<a name='L2619'></a>    <span class="keyword">if</span> (!node.hasClass(<span class="string">"snode"</span>)) {
<a name='L2620'></a>        <span class="keyword">return</span>;
<a name='L2621'></a>    }
<a name='L2622'></a>    <span class="keyword">if</span> (oldlabel) {
<a name='L2623'></a>        <span class="comment">// should never be needed, but a bit of defensiveness can't hurt</span>
<a name='L2624'></a>        oldlabel = parseLabel($.trim(oldlabel));
<a name='L2625'></a>    } <span class="keyword">else</span> {
<a name='L2626'></a>        <span class="comment">// oldlabel wasn't supplied -- try to guess</span>
<a name='L2627'></a>        oldlabel = node.attr(<span class="string">"class"</span>).split(<span class="string">" "</span>);
<a name='L2628'></a>        oldlabel = _.find(oldlabel, <span class="keyword">function</span> (s) { <span class="keyword">return</span> /[A-Z-]/.match(s); });
<a name='L2629'></a>    }
<a name='L2630'></a>    node.removeClass(oldlabel);
<a name='L2631'></a>    node.addClass(parseLabel(getLabel(node)));
<a name='L2632'></a>}
<a name='L2633'></a>
<a name='L2634'></a><span class="comment">//================================================== Obsolete/other</span>
<a name='L2635'></a>
<a name='L2636'></a><span class="comment">/**
<a name='L2637'></a> * Sets the label of a node
<a name='L2638'></a> *
<a name='L2639'></a> * Contains none of the heuristics of {@link setLabel}.
<a name='L2640'></a> *
<a name='L2641'></a> *<span class="phpdoc"> @param</span> {JQuery Node} node the target node
<a name='L2642'></a> *<span class="phpdoc"> @param</span> {String} label the new label
<a name='L2643'></a> *<span class="phpdoc"> @param</span> {Boolean} noUndo whether to record this operation for later undo
<a name='L2644'></a> */</span>
<a name='L2645'></a><span class="keyword">function</span> setNodeLabel(node, label, noUndo) {
<a name='L2646'></a>    <span class="comment">// TODO: fold this and setLabelLL together...</span>
<a name='L2647'></a>    setLabelLL(node, label);
<a name='L2648'></a>}
<a name='L2649'></a>
<a name='L2650'></a><span class="comment">// TODO(AWE): I think that updating labels on changing nodes works, but</span>
<a name='L2651'></a><span class="comment">// this fn should be interactively called with debugging arg to test this</span>
<a name='L2652'></a><span class="comment">// supposition.  When I am confident of the behavior of the code, this fn will</span>
<a name='L2653'></a><span class="comment">// be removed.</span>
<a name='L2654'></a><span class="keyword">function</span> resetLabelClasses(alertOnError) {
<a name='L2655'></a>    <span class="keyword">var</span> nodes = $(<span class="string">".snode"</span>).each(
<a name='L2656'></a>        <span class="keyword">function</span>() {
<a name='L2657'></a>            <span class="keyword">var</span> node = $(<span class="keyword">this</span>);
<a name='L2658'></a>            <span class="keyword">var</span> label = $.trim(getLabel(node));
<a name='L2659'></a>            <span class="keyword">if</span> (alertOnError) {
<a name='L2660'></a>                <span class="keyword">var</span> classes = node.attr(<span class="string">"class"</span>).split(<span class="string">" "</span>);
<a name='L2661'></a>                <span class="comment">// This incantation removes a value from an array.</span>
<a name='L2662'></a>                classes.indexOf(<span class="string">"snode"</span>) >= <span class="number">0</span> &amp;&amp;
<a name='L2663'></a>                    classes.splice(classes.indexOf(<span class="string">"snode"</span>), <span class="number">1</span>);
<a name='L2664'></a>                classes.indexOf(label) >= <span class="number">0</span> &amp;&amp;
<a name='L2665'></a>                    classes.splice(classes.indexOf(label), <span class="number">1</span>);
<a name='L2666'></a>                <span class="keyword">if</span> (classes.length > <span class="number">0</span>) {
<a name='L2667'></a>                    alert(<span class="string">"Spurious classes '"</span> + classes.join() +
<a name='L2668'></a>                          <span class="string">"' detected on node id'"</span> + node.attr(<span class="string">"id"</span>) + <span class="string">"'"</span>);
<a name='L2669'></a>                }
<a name='L2670'></a>            }
<a name='L2671'></a>        node.attr(<span class="string">"class"</span>, <span class="string">"snode "</span> + label);
<a name='L2672'></a>        });
<a name='L2673'></a>}
<a name='L2674'></a>
<a name='L2675'></a>
<a name='L2676'></a><span class="comment">// TODO: badly need a DSL for forms</span>
<a name='L2677'></a>
<a name='L2678'></a><span class="comment">// Local Variables:</span>
<a name='L2679'></a><span class="comment">// js2-additional-externs: ("$" "setTimeout" "customCommands\</span>
<a name='L2680'></a><span class="comment">// " "customConLeafBefore" "customConMenuGroups" "extensions" "leaf_extensions\</span>
<a name='L2681'></a><span class="comment">// " "clause_extensions" "JSON" "testValidLeafLabel" "testValidPhraseLabel\</span>
<a name='L2682'></a><span class="comment">// " "_" "startTime" "console" "loadContextMenu" "safeGet\</span>
<a name='L2683'></a><span class="comment">// " "jsonToTree" "objectToTree" "dictionaryToForm" "formToDictionary\</span>
<a name='L2684'></a><span class="comment">// " "displayWarning" "displayInfo" "displayError" "isEmpty" "isPossibleTarget\</span>
<a name='L2685'></a><span class="comment">// " "isRootNode" "isLeafNode" "guessLeafNode" "getTokenRoot" "wnodeString\</span>
<a name='L2686'></a><span class="comment">// " "currentText" "getLabel" "textNode" "getMetadata" "hasDashTag\</span>
<a name='L2687'></a><span class="comment">// " "parseIndex" "parseLabel" "parseIndexType" "getIndex" "getIndexType\</span>
<a name='L2688'></a><span class="comment">// " "shouldIndexLeaf" "maxIndex" "addToIndices" "changeJustLabel\</span>
<a name='L2689'></a><span class="comment">// " "toggleStringExtension" "lookupNextLabel" "commentTypes\</span>
<a name='L2690'></a><span class="comment">// " "invisibleCategories" "invisibleRootCategories" "ipnodes" "messageHistory\</span>
<a name='L2691'></a><span class="comment">// " "scrollToNext")</span>
<a name='L2692'></a><span class="comment">// indent-tabs-mode: nil</span>
<a name='L2693'></a><span class="comment">// End:</span>
<a name='L2694'></a>
</code>
  </pre>

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3</a> on Fri Aug 17 2012 00:45:11 GMT-0400 (EDT)
</footer>

</body>
</html>


